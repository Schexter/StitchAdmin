<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L-Shop Import - StitchAdmin</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }
        .upload-area.dragover {
            border-color: #0056b3;
            background-color: #e3f2fd;
        }
        .file-info {
            display: none;
            margin-top: 20px;
        }
        .validation-result {
            margin-top: 15px;
        }
        .import-options {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .recent-imports {
            max-height: 400px;
            overflow-y: auto;
        }
        .status-badge {
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Navigation würde hier eingefügt -->
            <div class="col-md-12">
                <div class="container mt-4">
                    <!-- Header -->
                    <div class="row mb-4">
                        <div class="col">
                            <h1><i class="fas fa-file-import"></i> L-Shop Import</h1>
                            <p class="text-muted">Importieren Sie Artikel aus L-Shop Excel/CSV-Dateien mit automatischer Variantenerkennung</p>
                        </div>
                    </div>

                    <!-- Alerts -->
                    <div id="alerts"></div>

                    <div class="row">
                        <!-- Import Bereich -->
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-upload"></i> Datei hochladen</h5>
                                </div>
                                <div class="card-body">
                                    <form id="importForm" method="POST" enctype="multipart/form-data">
                                        <!-- Upload Area -->
                                        <div class="upload-area" id="uploadArea">
                                            <div id="uploadPrompt">
                                                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                                <h5>Datei hier ablegen oder klicken zum Auswählen</h5>
                                                <p class="text-muted">Unterstützte Formate: CSV, Excel (.xlsx, .xls)</p>
                                                <input type="file" id="fileInput" name="file" accept=".csv,.xlsx,.xls" style="display: none;">
                                                <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                                    <i class="fas fa-folder-open"></i> Datei auswählen
                                                </button>
                                            </div>
                                            
                                            <!-- File Info -->
                                            <div class="file-info" id="fileInfo">
                                                <div class="alert alert-info">
                                                    <h6><i class="fas fa-file"></i> <span id="fileName"></span></h6>
                                                    <p class="mb-0">Größe: <span id="fileSize"></span></p>
                                                </div>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFile()">
                                                    <i class="fas fa-times"></i> Entfernen
                                                </button>
                                            </div>
                                            
                                            <!-- Validation Result -->
                                            <div class="validation-result" id="validationResult"></div>
                                        </div>

                                        <!-- Import Options -->
                                        <div class="import-options" id="importOptions" style="display: none;">
                                            <h6><i class="fas fa-cog"></i> Import-Optionen</h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="updateExisting" name="update_existing" checked>
                                                        <label class="form-check-label" for="updateExisting">
                                                            Bestehende Artikel aktualisieren
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="autoCalculatePrices" name="auto_calculate_prices" checked>
                                                        <label class="form-check-label" for="autoCalculatePrices">
                                                            VK-Preise automatisch kalkulieren
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="createCategories" name="create_categories">
                                                        <label class="form-check-label" for="createCategories">
                                                            Neue Kategorien erstellen
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="validatePrices" name="validate_prices" checked>
                                                        <label class="form-check-label" for="validatePrices">
                                                            Preise validieren
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Import Button -->
                                        <div class="text-center mt-4">
                                            <button type="submit" class="btn btn-success btn-lg" id="importBtn" disabled>
                                                <i class="fas fa-play"></i> Import starten
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Import Progress -->
                            <div class="card mt-4" id="progressCard" style="display: none;">
                                <div class="card-header">
                                    <h5><i class="fas fa-spinner fa-spin"></i> Import läuft...</h5>
                                </div>
                                <div class="card-body">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" style="width: 0%" id="progressBar">0%</div>
                                    </div>
                                    <p class="mt-2 mb-0" id="progressText">Import wird vorbereitet...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="col-lg-4">
                            <!-- Statistiken -->
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-bar"></i> Statistiken</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <h4 class="text-primary" id="totalArticles">-</h4>
                                            <small>Artikel</small>
                                        </div>
                                        <div class="col-4">
                                            <h4 class="text-success" id="totalVariants">-</h4>
                                            <small>Varianten</small>
                                        </div>
                                        <div class="col-4">
                                            <h4 class="text-info" id="lshopArticles">-</h4>
                                            <small>L-Shop</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Letzte Imports -->
                            <div class="card mt-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-history"></i> Letzte Imports</h5>
                                    <a href="/admin/lshop/import/history" class="btn btn-sm btn-outline-primary">
                                        Alle anzeigen
                                    </a>
                                </div>
                                <div class="card-body p-0">
                                    <div class="recent-imports">
                                        <div id="recentImportsList">
                                            <!-- Wird via JavaScript gefüllt -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hilfe -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5><i class="fas fa-question-circle"></i> Hilfe</h5>
                                </div>
                                <div class="card-body">
                                    <h6>Unterstützte Dateiformate:</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-file-csv text-success"></i> CSV-Dateien</li>
                                        <li><i class="fas fa-file-excel text-success"></i> Excel (.xlsx, .xls)</li>
                                    </ul>
                                    
                                    <h6 class="mt-3">Erforderliche Spalten:</h6>
                                    <ul class="list-unstyled small">
                                        <li>• Art. Nr.</li>
                                        <li>• Wahlbuch (Name)</li>
                                        <li>• Marke</li>
                                        <li>• Farbe</li>
                                        <li>• Größe</li>
                                    </ul>
                                    
                                    <div class="alert alert-info mt-3">
                                        <small>
                                            <i class="fas fa-info-circle"></i>
                                            StitchAdmin erstellt automatisch eindeutige Artikelnummern für alle Varianten.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Globale Variablen
        let selectedFile = null;
        let validationResult = null;

        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const importOptions = document.getElementById('importOptions');
        const importBtn = document.getElementById('importBtn');
        const importForm = document.getElementById('importForm');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadRecentImports();
            setupEventListeners();
        });

        function setupEventListeners() {
            // File Input Change
            fileInput.addEventListener('change', handleFileSelect);
            
            // Drag and Drop
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            
            // Form Submit
            importForm.addEventListener('submit', handleImportSubmit);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                setSelectedFile(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave() {
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                setSelectedFile(files[0]);
                fileInput.files = files;
            }
        }

        function setSelectedFile(file) {
            selectedFile = file;
            
            // Zeige Datei-Info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            
            uploadPrompt.style.display = 'none';
            fileInfo.style.display = 'block';
            
            // Validiere Datei
            validateFile(file);
        }

        function clearFile() {
            selectedFile = null;
            validationResult = null;
            fileInput.value = '';
            
            uploadPrompt.style.display = 'block';
            fileInfo.style.display = 'none';
            importOptions.style.display = 'none';
            
            document.getElementById('validationResult').innerHTML = '';
            importBtn.disabled = true;
        }

        function validateFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            // Zeige Loading
            document.getElementById('validationResult').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin"></i> Datei wird validiert...
                </div>
            `;
            
            fetch('/admin/lshop/validate', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                validationResult = result;
                showValidationResult(result);
                
                if (result.valid) {
                    importOptions.style.display = 'block';
                    importBtn.disabled = false;
                } else {
                    importOptions.style.display = 'none';
                    importBtn.disabled = true;
                }
            })
            .catch(error => {
                showAlert('Validierungsfehler: ' + error.message, 'danger');
                importBtn.disabled = true;
            });
        }

        function showValidationResult(result) {
            const validationDiv = document.getElementById('validationResult');
            
            if (result.valid) {
                validationDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Datei erfolgreich validiert
                        <ul class="mb-0 mt-2">
                            <li>Dateityp: ${result.file_type}</li>
                            <li>Geschätzte Zeilen: ${result.estimated_rows}</li>
                            <li>Gefundene Spalten: ${result.found_columns.join(', ')}</li>
                        </ul>
                    </div>
                `;
            } else {
                validationDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Validierung fehlgeschlagen
                        <p class="mb-0 mt-2">${result.error}</p>
                        ${result.missing_columns ? `<p class="mb-0">Fehlende Spalten: ${result.missing_columns.join(', ')}</p>` : ''}
                    </div>
                `;
            }
        }

        function handleImportSubmit(event) {
            event.preventDefault();
            
            if (!selectedFile || !validationResult || !validationResult.valid) {
                showAlert('Bitte wählen Sie eine gültige Datei aus', 'warning');
                return;
            }
            
            // Zeige Progress
            document.getElementById('progressCard').style.display = 'block';
            importBtn.disabled = true;
            
            // Simuliere Progress (real progress würde WebSocket oder Polling benötigen)
            simulateProgress();
            
            // Submit Form
            importForm.submit();
        }

        function simulateProgress() {
            let progress = 0;
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            const interval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress >= 90) {
                    progress = 90;
                    clearInterval(interval);
                }
                
                progressBar.style.width = progress + '%';
                progressBar.textContent = Math.round(progress) + '%';
                
                if (progress < 30) {
                    progressText.textContent = 'Datei wird verarbeitet...';
                } else if (progress < 60) {
                    progressText.textContent = 'Artikel werden importiert...';
                } else {
                    progressText.textContent = 'Varianten werden erstellt...';
                }
            }, 500);
        }

        function loadStatistics() {
            fetch('/admin/lshop/api/statistics')
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        document.getElementById('totalArticles').textContent = data.totals.articles;
                        document.getElementById('totalVariants').textContent = data.totals.variants;
                        document.getElementById('lshopArticles').textContent = data.totals.lshop_articles;
                    }
                })
                .catch(error => console.error('Statistiken Fehler:', error));
        }

        function loadRecentImports() {
            fetch('/admin/lshop/api/statistics')
                .then(response => response.json())
                .then(data => {
                    if (!data.error && data.recent_imports) {
                        showRecentImports(data.recent_imports);
                    }
                })
                .catch(error => console.error('Recent Imports Fehler:', error));
        }

        function showRecentImports(imports) {
            const listDiv = document.getElementById('recentImportsList');
            
            if (imports.length === 0) {
                listDiv.innerHTML = '<p class="text-muted text-center p-3">Noch keine Imports</p>';
                return;
            }
            
            let html = '';
            imports.forEach(imp => {
                const statusClass = imp.status === 'completed' ? 'success' : 
                                  imp.status === 'failed' ? 'danger' : 'warning';
                const statusIcon = imp.status === 'completed' ? 'check-circle' : 
                                 imp.status === 'failed' ? 'exclamation-triangle' : 'clock';
                
                const date = new Date(imp.started_at).toLocaleString('de-DE');
                
                html += `
                    <div class="border-bottom p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${imp.filename}</h6>
                                <small class="text-muted">${date}</small>
                            </div>
                            <span class="badge bg-${statusClass} status-badge">
                                <i class="fas fa-${statusIcon}"></i> ${imp.status}
                            </span>
                        </div>
                        <div class="row text-center mt-2">
                            <div class="col-6">
                                <small class="text-success">+${imp.new_articles} Artikel</small>
                            </div>
                            <div class="col-6">
                                <small class="text-info">+${imp.new_variants} Varianten</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showAlert(message, type = 'info') {
            const alertsDiv = document.getElementById('alerts');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="${alertId}">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertsDiv.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remove nach 5 Sekunden
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
