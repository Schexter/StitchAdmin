{% extends "base.html" %}

{% block title %}{{ article.name }} bearbeiten - StitchAdmin{% endblock %}

{% block content %}
<!-- DEBUG INFO START -->
<div class="alert alert-warning">
    <h5>DEBUG: Template Variables</h5>
    <p>price_factors exists: {{ price_factors is defined }}</p>
    <p>product_categories exists: {{ product_categories is defined }}</p>
    <p>brands exists: {{ brands is defined }}</p>
    <p>Article has new fields: 
        - purchase_price_single: {{ article.purchase_price_single if article else 'No article' }}
        - category_id: {{ article.category_id if article else 'No article' }}
    </p>
    <p>Template loaded at: {{ now() if now is defined else 'Now not available' }}</p>
</div>
<!-- DEBUG INFO END -->
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="row">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('articles.index') }}">Artikel</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('articles.show', article_id=article.id) }}">{{ article.name }}</a></li>
                <li class="breadcrumb-item active">Bearbeiten</li>
            </ol>
        </nav>
        
        <h1><i class="bi bi-pencil"></i> {{ article.name }} bearbeiten</h1>
    </div>
</div>

<form method="POST">
    <div class="row">
        <div class="col-md-8">
            <!-- Basis-Informationen -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Basis-Informationen</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Name *</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ article.name }}" required autofocus>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="article_number" class="form-label">StitchAdmin Artikelnummer</label>
                            <input type="text" class="form-control" id="article_number" name="article_number" 
                                   value="{{ article.article_number or '' }}" readonly style="background-color: #f8f9fa;">
                            <small class="text-muted">Wird automatisch generiert</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="product_type" class="form-label">Produkttyp</label>
                            <input type="text" class="form-control" id="product_type" name="product_type" 
                                   value="{{ article.product_type or '' }}" placeholder="z.B. T-Shirt, Polo, etc.">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="manufacturer_number" class="form-label">Herstellernummer</label>
                            <input type="text" class="form-control" id="manufacturer_number" name="manufacturer_number" 
                                   value="{{ article.manufacturer_number or '' }}">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Beschreibung</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ article.description or '' }}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="category_id" class="form-label">Kategorie</label>
                            <select class="form-control" id="category_id" name="category_id">
                                <option value="">-- Keine Kategorie --</option>
                                {% for cat in product_categories %}
                                <option value="{{ cat.id }}" {% if article.category_id == cat.id %}selected{% endif %}>
                                    {{ cat.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Alt-Kategorie: {{ article.category or '-' }}</small>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="brand_id" class="form-label">Marke</label>
                            <select class="form-control" id="brand_id" name="brand_id">
                                <option value="">-- Keine Marke --</option>
                                {% for br in brands %}
                                <option value="{{ br.id }}" {% if article.brand_id == br.id %}selected{% endif %}>
                                    {{ br.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Alt-Marke: {{ article.brand or '-' }}</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Preis-Informationen -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Preis-Informationen</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-muted mb-3">Einkaufspreise (netto)</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="purchase_price_single" class="form-label">EK Einzelpreis (€)</label>
                            <input type="text" class="form-control" id="purchase_price_single" name="purchase_price_single" 
                                   value="{{ '%.2f'|format(article.purchase_price_single or 0)|replace('.', ',') }}" 
                                   placeholder="0,00" pattern="[0-9]+([,\.][0-9]{1,2})?" onchange="calculatePrices()">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="purchase_price_carton" class="form-label">EK Kartonpreis (€)</label>
                            <input type="text" class="form-control" id="purchase_price_carton" name="purchase_price_carton" 
                                   value="{{ '%.2f'|format(article.purchase_price_carton or 0)|replace('.', ',') }}" 
                                   placeholder="0,00" pattern="[0-9]+([,\.][0-9]{1,2})?" onchange="calculatePrices()">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="purchase_price_10carton" class="form-label">EK 10-Karton (€)</label>
                            <input type="text" class="form-control" id="purchase_price_10carton" name="purchase_price_10carton" 
                                   value="{{ '%.2f'|format(article.purchase_price_10carton or 0)|replace('.', ',') }}" 
                                   placeholder="0,00" pattern="[0-9]+([,\.][0-9]{1,2})?" onchange="calculatePrices()">
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6 class="text-muted mb-3">Verkaufspreise (netto)</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="price" class="form-label">VK aktuell (€) *</label>
                            <input type="text" class="form-control" id="price" name="price" 
                                   value="{{ '%.2f'|format(article.price or 0)|replace('.', ',') }}" 
                                   placeholder="0,00" required pattern="[0-9]+([,\.][0-9]{1,2})?">
                            <small class="text-muted">Brutto: <span id="price_gross">{{ '%.2f'|format((article.price or 0) * 1.19) }}</span> €</small>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="price_calculated" class="form-label">VK kalkuliert (€)</label>
                            <input type="text" class="form-control" id="price_calculated" name="price_calculated" 
                                   value="{{ '%.2f'|format(article.price_calculated or 0)|replace('.', ',') }}" 
                                   readonly style="background-color: #f0f0f0;">
                            <small class="text-muted">EK × 1,5</small>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="price_recommended" class="form-label">VK empfohlen (€)</label>
                            <input type="text" class="form-control" id="price_recommended" name="price_recommended" 
                                   value="{{ '%.2f'|format(article.price_recommended or 0)|replace('.', ',') }}" 
                                   readonly style="background-color: #f0f0f0;">
                            <small class="text-muted">EK × 2,0</small>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Kalkulationsfaktoren: VK kalkuliert = EK × {{ price_factors.calculated if price_factors else 1.5 }}, VK empfohlen = EK × {{ price_factors.recommended if price_factors else 2.0 }}<br>
                        Die Faktoren können in den <a href="{{ url_for('settings.index') }}">Einstellungen</a> angepasst werden.
                    </div>
                </div>
            </div>
            
            <!-- Eigenschaften -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Eigenschaften</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="size" class="form-label">Größe</label>
                            <input type="text" class="form-control" id="size" name="size" 
                                   value="{{ article.size or '' }}" placeholder="z.B. M, 38, 100x150cm">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="color" class="form-label">Farbe</label>
                            <input type="text" class="form-control" id="color" name="color" 
                                   value="{{ article.color or '' }}" placeholder="z.B. Rot, Blau gemustert">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="weight" class="form-label">Gewicht (kg)</label>
                            <input type="number" class="form-control" id="weight" name="weight" 
                                   value="{{ article.weight or 0 }}" step="0.001" min="0"
                                   placeholder="z.B. 0.250">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="material" class="form-label">Material / Zusammensetzung</label>
                        <input type="text" class="form-control" id="material" name="material" 
                               value="{{ article.material or '' }}" placeholder="z.B. 100% Baumwolle, Polyester/Elastan">
                    </div>
                </div>
            </div>
            
            <!-- Lieferanten-Informationen -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Lieferanten-Informationen</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleMultiSupplier()">
                        <i class="bi bi-plus"></i> Multi-Lieferanten
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="supplier" class="form-label">Hauptlieferant</label>
                            <select class="form-control" id="supplier" name="supplier">
                                <option value="">-- Kein Lieferant --</option>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}" {% if article.supplier == supplier.id %}selected{% endif %}>
                                    {{ supplier.name }} ({{ supplier.id }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="supplier_article_number" class="form-label">L-Shop Artikelnummer</label>
                            <input type="text" class="form-control" id="supplier_article_number" 
                                   name="supplier_article_number" 
                                   value="{{ article.supplier_article_number or '' }}">
                            <small class="text-muted">Original L-Shop Art. Nr.</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="location" class="form-label">Lagerort</label>
                        <input type="text" class="form-control" id="location" name="location" 
                               value="{{ article.location or '' }}" placeholder="z.B. Regal A, Fach 3">
                    </div>
                    
                    <!-- Multi-Lieferanten Bereich -->
                    <div id="multiSupplierSection" style="display: none;">
                        <hr>
                        <h6 class="text-muted mb-3">Weitere Lieferanten</h6>
                        {% if article.supplier_articles %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Lieferant</th>
                                        <th>Art.Nr.</th>
                                        <th>EK-Preis</th>
                                        <th>Aktiv</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for supplier_link in article.supplier_articles %}
                                    <tr>
                                        <td>{{ supplier_link.supplier.name }}</td>
                                        <td>{{ supplier_link.supplier_article_number or '-' }}</td>
                                        <td>{{ "%.2f"|format(supplier_link.purchase_price or 0) }} €</td>
                                        <td>
                                            {% if supplier_link.is_available %}
                                                <span class="badge bg-success">Ja</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Nein</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="removeSupplier('{{ supplier_link.supplier_id }}')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">Keine weiteren Lieferanten verknüpft.</p>
                        {% endif %}
                        <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addSupplierModal">
                            <i class="bi bi-plus"></i> Lieferant hinzufügen
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Lagerbestand -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Lagerbestand</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="stock" class="form-label">Aktueller Bestand</label>
                        <input type="number" class="form-control" id="stock" name="stock" 
                               value="{{ article.stock or 0 }}" min="0">
                    </div>
                    
                    <div class="mb-3">
                        <label for="min_stock" class="form-label">Mindestbestand</label>
                        <input type="number" class="form-control" id="min_stock" name="min_stock" 
                               value="{{ article.min_stock or 0 }}" min="0">
                        <small class="text-muted">Warnung bei Unterschreitung</small>
                    </div>
                </div>
            </div>
            
            <!-- Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Status</h5>
                </div>
                <div class="card-body">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="active" name="active" 
                               {% if article.active %}checked{% endif %}>
                        <label class="form-check-label" for="active">
                            Artikel ist aktiv
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Metadaten -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Informationen</h5>
                </div>
                <div class="card-body">
                    <small class="text-muted">
                        <strong>Erstellt:</strong> {{ article.created_at.strftime('%d.%m.%Y %H:%M') if article.created_at else 'Unbekannt' }}<br>
                        {% if article.created_by %}
                        <strong>Von:</strong> {{ article.created_by }}<br>
                        {% endif %}
                        {% if article.updated_at %}
                        <strong>Zuletzt geändert:</strong> {{ article.updated_at.strftime('%d.%m.%Y %H:%M') }}<br>
                        {% endif %}
                        {% if article.updated_by %}
                        <strong>Von:</strong> {{ article.updated_by }}
                        {% endif %}
                    </small>
                </div>
            </div>
            
            <!-- Aktionen -->
            <div class="card">
                <div class="card-body">
                    <button type="submit" class="btn btn-success w-100 mb-2">
                        <i class="bi bi-save"></i> Änderungen speichern
                    </button>
                    <a href="{{ url_for('articles.show', article_id=article.id) }}" class="btn btn-secondary w-100">
                        <i class="bi bi-x-circle"></i> Abbrechen
                    </a>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
// Preis-Formatierung und Kalkulation
const priceFactors = {
    calculated: {{ price_factors.calculated if price_factors else 1.5 }},
    recommended: {{ price_factors.recommended if price_factors else 2.0 }}
};

// Event Listener für alle Preisfelder
document.getElementById('price').addEventListener('blur', function() {
    formatPrice(this);
    updateGrossPrice();
});

document.getElementById('purchase_price_single').addEventListener('blur', function() {
    formatPrice(this);
    calculatePrices();
});

document.getElementById('purchase_price_carton').addEventListener('blur', function() {
    formatPrice(this);
    calculatePrices();
});

document.getElementById('purchase_price_10carton').addEventListener('blur', function() {
    formatPrice(this);
    calculatePrices();
});

function formatPrice(input) {
    let value = input.value.replace(',', '.');
    if (value && !isNaN(value)) {
        input.value = parseFloat(value).toFixed(2).replace('.', ',');
    }
}

function calculatePrices() {
    // Hole EK-Preise
    const ekSingle = parseFloat(document.getElementById('purchase_price_single').value.replace(',', '.')) || 0;
    const ekCarton = parseFloat(document.getElementById('purchase_price_carton').value.replace(',', '.')) || 0;
    const ek10Carton = parseFloat(document.getElementById('purchase_price_10carton').value.replace(',', '.')) || 0;
    
    // Finde niedrigsten EK-Preis (größer als 0)
    let basePrice = 0;
    if (ekSingle > 0) basePrice = ekSingle;
    if (ekCarton > 0 && (basePrice === 0 || ekCarton < basePrice)) basePrice = ekCarton;
    if (ek10Carton > 0 && (basePrice === 0 || ek10Carton < basePrice)) basePrice = ek10Carton;
    
    // Berechne VK-Preise
    const priceCalculated = basePrice * priceFactors.calculated;
    const priceRecommended = basePrice * priceFactors.recommended;
    
    // Aktualisiere Felder
    document.getElementById('price_calculated').value = priceCalculated.toFixed(2).replace('.', ',');
    document.getElementById('price_recommended').value = priceRecommended.toFixed(2).replace('.', ',');
    
    // Wenn noch kein VK gesetzt, setze kalkulierten Preis
    const currentPrice = parseFloat(document.getElementById('price').value.replace(',', '.')) || 0;
    if (currentPrice === 0 && priceCalculated > 0) {
        document.getElementById('price').value = priceCalculated.toFixed(2).replace('.', ',');
        updateGrossPrice();
    }
}

function updateGrossPrice() {
    const netPrice = parseFloat(document.getElementById('price').value.replace(',', '.')) || 0;
    const grossPrice = netPrice * 1.19;
    document.getElementById('price_gross').textContent = grossPrice.toFixed(2).replace('.', ',');
}

// Initial calculation on page load
document.addEventListener('DOMContentLoaded', function() {
    calculatePrices();
    updateGrossPrice();
});

// Multi-Lieferanten Funktionen
function toggleMultiSupplier() {
    const section = document.getElementById('multiSupplierSection');
    if (section.style.display === 'none') {
        section.style.display = 'block';
    } else {
        section.style.display = 'none';
    }
}

function removeSupplier(supplierId) {
    if (confirm('Möchten Sie diesen Lieferanten wirklich entfernen?')) {
        // TODO: AJAX-Call zum Entfernen des Lieferanten
        console.log('Remove supplier:', supplierId);
    }
}
</script>
{% endblock %}