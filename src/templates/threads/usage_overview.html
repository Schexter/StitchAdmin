{% extends "base.html" %}

{% block title %}Garnverbrauch Übersicht - StitchAdmin{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="bi bi-graph-up"></i> Garnverbrauch Übersicht</h1>
            <div>
                <a href="{{ url_for('thread.record_usage') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Verbrauch erfassen
                </a>
                <a href="{{ url_for('thread.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a href="{{ url_for('thread.index') }}" class="btn btn-outline-primary">
                    <i class="bi bi-list"></i> Zur Übersicht
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Zeitraum-Filter -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="btn-group" role="group">
            <a href="{{ url_for('thread.usage_overview', period='7') }}"
               class="btn btn-sm btn-outline-primary {% if period == '7' %}active{% endif %}">
                Letzte 7 Tage
            </a>
            <a href="{{ url_for('thread.usage_overview', period='30') }}"
               class="btn btn-sm btn-outline-primary {% if period == '30' %}active{% endif %}">
                Letzte 30 Tage
            </a>
            <a href="{{ url_for('thread.usage_overview', period='90') }}"
               class="btn btn-sm btn-outline-primary {% if period == '90' %}active{% endif %}">
                Letzte 90 Tage
            </a>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Verbrauch nach Garn -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-palette"></i> Verbrauch nach Garn</h5>
            </div>
            <div class="card-body">
                {% if thread_stats %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Farbe</th>
                                <th>Hersteller</th>
                                <th>Nummer</th>
                                <th>Name</th>
                                <th class="text-end">Verbrauch (m)</th>
                                <th class="text-end">Häufigkeit</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in thread_stats %}
                            <tr>
                                <td>
                                    <span class="color-badge"
                                          style="background-color: {{ stat.hex_color or '#cccccc' }};
                                                 width: 30px; height: 20px; display: inline-block;
                                                 border: 1px solid #ddd; border-radius: 3px;">
                                    </span>
                                </td>
                                <td>{{ stat.manufacturer }}</td>
                                <td>{{ stat.color_number }}</td>
                                <td>{{ stat.color_name_de or '-' }}</td>
                                <td class="text-end"><strong>{{ "%.1f"|format(stat.total_used) }}</strong></td>
                                <td class="text-end">{{ stat.usage_count }}x</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">Keine Verbrauchsdaten im gewählten Zeitraum</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Verbrauch nach Maschine -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear-fill"></i> Verbrauch nach Maschine</h5>
            </div>
            <div class="card-body">
                {% if machine_stats %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Maschine</th>
                                <th class="text-end">Verbrauch (m)</th>
                                <th class="text-end">Häufigkeit</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in machine_stats %}
                            <tr>
                                <td>
                                    <i class="bi bi-gear text-primary"></i>
                                    {{ stat.machine_id }}
                                </td>
                                <td class="text-end"><strong>{{ "%.1f"|format(stat.total_used) }}</strong></td>
                                <td class="text-end">{{ stat.usage_count }}x</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">Keine Maschinendaten im gewählten Zeitraum</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Verbrauch nach Auftrag -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Verbrauch nach Auftrag</h5>
            </div>
            <div class="card-body">
                {% if order_stats %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Auftrags-ID</th>
                                <th class="text-end">Verbrauch (m)</th>
                                <th class="text-end">Häufigkeit</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in order_stats %}
                            <tr>
                                <td>
                                    <i class="bi bi-file-earmark"></i>
                                    <a href="{{ url_for('order.show', order_id=stat.order_id) }}">
                                        {{ stat.order_id }}
                                    </a>
                                </td>
                                <td class="text-end"><strong>{{ "%.1f"|format(stat.total_used) }}</strong></td>
                                <td class="text-end">{{ stat.usage_count }}x</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">Keine Auftragsdaten im gewählten Zeitraum</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Letzte Erfassungen -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Letzte Erfassungen</h5>
            </div>
            <div class="card-body">
                {% if recent_usage %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Datum/Zeit</th>
                                <th>Garn</th>
                                <th>Menge (m)</th>
                                <th>Maschine</th>
                                <th>Auftrag</th>
                                <th>Typ</th>
                                <th>Erfasst von</th>
                                <th>Notizen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for usage in recent_usage %}
                            <tr>
                                <td>
                                    <small>{{ usage.used_at.strftime('%d.%m.%Y %H:%M') }}</small>
                                </td>
                                <td>
                                    {% if usage.thread %}
                                    <span class="color-badge"
                                          style="background-color: {{ usage.thread.hex_color or '#cccccc' }};
                                                 width: 20px; height: 15px; display: inline-block;
                                                 border: 1px solid #ddd; border-radius: 2px; margin-right: 5px;">
                                    </span>
                                    {{ usage.thread.manufacturer }} {{ usage.thread.color_number }}
                                    {% else %}
                                    <span class="text-muted">Unbekannt</span>
                                    {% endif %}
                                </td>
                                <td><strong>{{ "%.1f"|format(usage.quantity_used) }}</strong></td>
                                <td>
                                    {% if usage.machine_id %}
                                    <i class="bi bi-gear text-primary"></i> {{ usage.machine_id }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if usage.order_id %}
                                    <a href="{{ url_for('order.show', order_id=usage.order_id) }}">
                                        {{ usage.order_id }}
                                    </a>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if usage.usage_type == 'production' %}
                                    <span class="badge bg-success">Produktion</span>
                                    {% elif usage.usage_type == 'test' %}
                                    <span class="badge bg-info">Test</span>
                                    {% elif usage.usage_type == 'waste' %}
                                    <span class="badge bg-warning">Verschnitt</span>
                                    {% elif usage.usage_type == 'correction' %}
                                    <span class="badge bg-secondary">Korrektur</span>
                                    {% else %}
                                    <span class="badge bg-light text-dark">{{ usage.usage_type }}</span>
                                    {% endif %}
                                </td>
                                <td><small>{{ usage.recorded_by or '-' }}</small></td>
                                <td><small>{{ usage.notes or '-' }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">Noch keine Verbrauchsdaten erfasst</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: none;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #e9ecef;
    border-radius: 8px 8px 0 0 !important;
}

.table-hover tbody tr:hover {
    background-color: #f8f9fa;
}

.color-badge {
    vertical-align: middle;
}

.btn-group .btn.active {
    background-color: #0d6efd;
    color: white;
}
</style>
{% endblock %}
