{% extends "base.html" %}

{% block title %}Meine Module - StitchAdmin{% endblock %}

{% block content %}

<div class="row">
    <div class="col-md-12">
        <h1><i class="bi bi-grid-3x3"></i> Meine Module</h1>
        <p class="text-muted">Verwalten Sie hier die Sichtbarkeit und Anordnung Ihrer Dashboard-Module</p>

        <div class="mb-3">
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Zurück zum Dashboard
            </a>
            <button class="btn btn-warning" onclick="resetToDefault()">
                <i class="bi bi-arrow-counterclockwise"></i> Auf Standard zurücksetzen
            </button>
        </div>
    </div>
</div>

<!-- Statistik -->
<div class="row mb-3">
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body">
                <h6 class="text-muted">Gesamt</h6>
                <h3 class="mb-0">{{ modules|length }}</h3>
                <small class="text-muted">Verfügbare Module</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body">
                <h6 class="text-muted">Aktiv</h6>
                <h3 class="mb-0">{{ modules|selectattr('visible')|list|length }}</h3>
                <small class="text-muted">Sichtbar im Dashboard</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-secondary">
            <div class="card-body">
                <h6 class="text-muted">Ausgeblendet</h6>
                <h3 class="mb-0">{{ modules|rejectattr('visible')|list|length }}</h3>
                <small class="text-muted">Nicht sichtbar</small>
            </div>
        </div>
    </div>
</div>

<!-- Module-Verwaltung -->
<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-sliders"></i> Modul-Einstellungen</h5>
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">
            <i class="bi bi-info-circle"></i>
            Schalten Sie Module ein oder aus. Ausgeblendete Module erscheinen nicht mehr auf Ihrem Dashboard.
        </p>

        <div class="table-responsive">
            <table class="table table-hover" id="modulesTable">
                <thead>
                    <tr>
                        <th style="width: 50px;"></th>
                        <th>Icon</th>
                        <th>Modul</th>
                        <th>Beschreibung</th>
                        <th>Kategorie</th>
                        <th>Status</th>
                        <th style="width: 150px;">Aktionen</th>
                    </tr>
                </thead>
                <tbody id="modulesList">
                    {% for item in modules %}
                    {% set module = item.module %}
                    <tr data-module-id="{{ module.id }}" class="{% if not item.visible %}table-secondary{% endif %}">
                        <td>
                            <i class="bi bi-grip-vertical text-muted" style="cursor: move;" title="Verschieben"></i>
                        </td>
                        <td>
                            <span class="badge bg-{{ module.color }}" style="font-size: 1.2em;">
                                {% if module.icon and module.icon.startswith('bi-') %}
                                    <i class="bi {{ module.icon }}"></i>
                                {% else %}
                                    <i class="bi bi-grid-fill"></i>
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <strong>{{ module.display_name }}</strong>
                            {% if module.requires_admin %}
                            <span class="badge bg-warning ms-2">Admin</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">{{ module.description }}</small>
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ module.category }}</span>
                        </td>
                        <td>
                            {% if item.visible %}
                                <span class="badge bg-success">
                                    <i class="bi bi-eye"></i> Sichtbar
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">
                                    <i class="bi bi-eye-slash"></i> Ausgeblendet
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-{% if item.visible %}warning{% else %}success{% endif %}"
                                    onclick="toggleModule({{ module.id }}, {{ 'true' if item.visible else 'false' }})"
                                    id="toggle-btn-{{ module.id }}">
                                <i class="bi bi-{% if item.visible %}eye-slash{% else %}eye{% endif %}"></i>
                                {% if item.visible %}Ausblenden{% else %}Einblenden{% endif %}
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="alert alert-info mt-3">
            <i class="bi bi-lightbulb"></i>
            <strong>Tipp:</strong> Ziehen Sie die Module mit dem <i class="bi bi-grip-vertical"></i> Symbol,
            um die Reihenfolge auf Ihrem Dashboard zu ändern. Die Änderungen werden automatisch gespeichert.
        </div>
    </div>
</div>

<!-- SortableJS mit lokalem Fallback -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"
        onerror="this.onerror=null; var s=document.createElement('script'); s.src='{{ url_for('static', filename='vendor/sortablejs/Sortable.min.js') }}'; document.head.appendChild(s);"></script>
<script>
// Module ein-/ausblenden
function toggleModule(moduleId, currentlyVisible) {
    const btn = document.getElementById(`toggle-btn-${moduleId}`);
    const row = document.querySelector(`tr[data-module-id="${moduleId}"]`);

    btn.disabled = true;

    fetch(`/api/dashboard/module/${moduleId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Aktualisiere Button und Zeile
            const newVisible = data.visible;

            // Button-Text und Icon
            btn.innerHTML = newVisible
                ? '<i class="bi bi-eye-slash"></i> Ausblenden'
                : '<i class="bi bi-eye"></i> Einblenden';
            btn.className = newVisible
                ? 'btn btn-sm btn-warning'
                : 'btn btn-sm btn-success';

            // Zeilen-Styling
            if (newVisible) {
                row.classList.remove('table-secondary');
            } else {
                row.classList.add('table-secondary');
            }

            // Status-Badge
            const statusCell = row.cells[5];
            statusCell.innerHTML = newVisible
                ? '<span class="badge bg-success"><i class="bi bi-eye"></i> Sichtbar</span>'
                : '<span class="badge bg-secondary"><i class="bi bi-eye-slash"></i> Ausgeblendet</span>';

            // Update onclick
            btn.setAttribute('onclick', `toggleModule(${moduleId}, ${newVisible})`);

            // Statistiken aktualisieren
            updateStats();
        } else {
            alert('Fehler: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Umschalten des Moduls');
    })
    .finally(() => {
        btn.disabled = false;
    });
}

// Statistiken aktualisieren
function updateStats() {
    const rows = document.querySelectorAll('#modulesList tr');
    let visible = 0;
    let hidden = 0;

    rows.forEach(row => {
        if (row.classList.contains('table-secondary')) {
            hidden++;
        } else {
            visible++;
        }
    });

    // Update Kacheln (wenn vorhanden)
    const totalEl = document.querySelector('.row .col-md-3:nth-child(1) h3');
    const visibleEl = document.querySelector('.row .col-md-3:nth-child(2) h3');
    const hiddenEl = document.querySelector('.row .col-md-3:nth-child(3) h3');

    if (visibleEl) visibleEl.textContent = visible;
    if (hiddenEl) hiddenEl.textContent = hidden;
}

// Drag & Drop für Reihenfolge
const modulesList = document.getElementById('modulesList');
const sortable = new Sortable(modulesList, {
    handle: '.bi-grip-vertical',
    animation: 150,
    onEnd: function(evt) {
        saveOrder();
    }
});

// Reihenfolge speichern
function saveOrder() {
    const rows = document.querySelectorAll('#modulesList tr');
    const modules = [];

    rows.forEach((row, index) => {
        const moduleId = parseInt(row.getAttribute('data-module-id'));
        const isVisible = !row.classList.contains('table-secondary');

        modules.push({
            module_id: moduleId,
            order: index + 1,
            visible: isVisible,
            size: 'normal'
        });
    });

    fetch('/api/dashboard/layout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            modules: modules
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Reihenfolge gespeichert');
            // Optional: Kleine Bestätigung anzeigen
            showToast('Reihenfolge gespeichert');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Speichern der Reihenfolge');
    });
}

// Auf Standard zurücksetzen
function resetToDefault() {
    if (confirm('Möchten Sie wirklich alle Module auf die Standardeinstellungen zurücksetzen?')) {
        fetch('/api/dashboard/reset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Dashboard wurde zurückgesetzt');
                location.reload();
            } else {
                alert('Fehler: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Zurücksetzen');
        });
    }
}

// Toast-Benachrichtigung
function showToast(message) {
    // Einfache Toast-Implementierung
    const toast = document.createElement('div');
    toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `<i class="bi bi-check-circle"></i> ${message}`;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 2000);
}
</script>

{% endblock %}
