{% extends "base.html" %}

{% block title %}{{ customer.display_name or (customer.first_name ~ ' ' ~ customer.last_name) or customer.company_name }} - Kundendetails{% endblock %}

{% block content %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="row">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('customers.index') }}">Kunden</a></li>
                <li class="breadcrumb-item active">
                    {{ customer.display_name or (customer.first_name ~ ' ' ~ customer.last_name) or customer.company_name }}
                </li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                {% if customer.get('customer_type', 'private') == 'business' %}
                    <i class="bi bi-building"></i>
                {% else %}
                    <i class="bi bi-person-fill"></i>
                {% endif %}
                {{ customer.display_name or (customer.first_name ~ ' ' ~ customer.last_name) or customer.company_name }}
            </h1>
            <div>
                <a href="{{ url_for('customers.edit', customer_id=customer.id) }}" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Bearbeiten
                </a>
                <button class="btn btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash"></i> Löschen
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Persönliche/Firmen Daten -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    {% if customer.get('customer_type', 'private') == 'business' %}
                        Firmendaten
                    {% else %}
                        Persönliche Daten
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Kunden-Nr:</strong></div>
                    <div class="col-md-9">{{ customer.id }}</div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Kundentyp:</strong></div>
                    <div class="col-md-9">
                        {% if customer.get('customer_type', 'private') == 'business' %}
                            <span class="badge bg-info">Firmenkunde</span>
                        {% else %}
                            <span class="badge bg-success">Privatperson</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if customer.get('customer_type', 'private') == 'business' %}
                    <!-- Firmenkunden-Felder -->
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>Firmenname:</strong></div>
                        <div class="col-md-9">{{ customer.company_name }}</div>
                    </div>
                    
                    {% if customer.tax_id %}
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>Steuernummer:</strong></div>
                        <div class="col-md-9">{{ customer.tax_id }}</div>
                    </div>
                    {% endif %}
                    
                    {% if customer.vat_id %}
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>USt-ID:</strong></div>
                        <div class="col-md-9">{{ customer.vat_id }}</div>
                    </div>
                    {% endif %}
                    
                    {% if customer.contact_person %}
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>Ansprechpartner:</strong></div>
                        <div class="col-md-9">
                            {{ customer.contact_person }}
                            {% if customer.department %}
                                <br><small class="text-muted">{{ customer.department }}</small>
                            {% endif %}
                            {% if customer.position %}
                                <br><small class="text-muted">{{ customer.position }}</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% else %}
                    <!-- Privatpersonen-Felder -->
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>Name:</strong></div>
                        <div class="col-md-9">{{ customer.first_name }} {{ customer.last_name }}</div>
                    </div>
                    
                    {% if customer.birth_date %}
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>Geburtsdatum:</strong></div>
                        <div class="col-md-9">
                            {{ customer.birth_date|format_date }}
                            {% if customer.birth_date %}
                                {% set age = customer.birth_date|calculate_age %}
                                {% if age is not none %}
                                    <small class="text-muted">({{ age }} Jahre)</small>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% endif %}
                
                <div class="row mb-2">
                    <div class="col-md-3"><strong>E-Mail:</strong></div>
                    <div class="col-md-9">
                        {% if customer.email %}
                            <a href="mailto:{{ customer.email }}">{{ customer.email }}</a>
                        {% else %}
                            -
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Kontaktdaten -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Kontaktdaten</h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Telefon:</strong></div>
                    <div class="col-md-9">
                        {% if customer.phone %}
                            <a href="tel:{{ customer.phone }}">{{ customer.phone }}</a>
                        {% else %}
                            -
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Mobil:</strong></div>
                    <div class="col-md-9">
                        {% if customer.mobile %}
                            <a href="tel:{{ customer.mobile }}">{{ customer.mobile }}</a>
                        {% else %}
                            -
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Adresse -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Adresse</h5>
            </div>
            <div class="card-body">
                {% if customer.street or customer.city %}
                <address>
                    {% if customer.street %}
                        {{ customer.street }} {{ customer.house_number }}<br>
                    {% endif %}
                    {% if customer.postal_code or customer.city %}
                        {{ customer.postal_code }} {{ customer.city }}<br>
                    {% endif %}
                    {{ customer.country or 'Deutschland' }}
                </address>
                {% else %}
                <p class="text-muted">Keine Adresse hinterlegt</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Status</h5>
            </div>
            <div class="card-body">
                <p>
                    <strong>Newsletter:</strong> 
                    {% if customer.newsletter %}
                        <span class="badge bg-success">Abonniert</span>
                    {% else %}
                        <span class="badge bg-secondary">Nicht abonniert</span>
                    {% endif %}
                </p>
                <p>
                    <strong>Kunde seit:</strong><br>
                    {{ customer.created_at|format_date or 'Unbekannt' }}
                </p>
                {% if customer.updated_at %}
                <p>
                    <small class="text-muted">
                        Zuletzt aktualisiert: {{ customer.updated_at|format_date }}
                        {% if customer.updated_by %}
                            von {{ customer.updated_by }}
                        {% endif %}
                    </small>
                </p>
                {% endif %}
            </div>
        </div>
        
        <!-- Notizen -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Notizen</h5>
            </div>
            <div class="card-body">
                {% if customer.notes %}
                    <p>{{ customer.notes|nl2br }}</p>
                {% else %}
                    <p class="text-muted">Keine Notizen vorhanden</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Schnellaktionen -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Schnellaktionen</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if customer.email %}
                    <a href="mailto:{{ customer.email }}" class="btn btn-info">
                        <i class="bi bi-envelope"></i> E-Mail senden
                    </a>
                    {% endif %}
                    <a href="{{ url_for('orders.new') }}?customer_id={{ customer.id }}" class="btn btn-success">
                        <i class="bi bi-plus-circle"></i> Neuer Auftrag
                    </a>
                    <button class="btn btn-secondary" onclick="alert('Kaufhistorie wird in der nächsten Version implementiert')">
                        <i class="bi bi-clock-history"></i> Kaufhistorie
                    </button>
                    {% if customer.get('customer_type', 'private') == 'business' %}
                    <button class="btn btn-secondary" onclick="alert('Rechnungshistorie wird in der nächsten Version implementiert')">
                        <i class="bi bi-receipt"></i> Rechnungen
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Kunden-Historie -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Historie</h5>
            </div>
            <div class="card-body">
                {% if history %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Aktion</th>
                                <th>Details</th>
                                <th>Benutzer</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in history %}
                            <tr>
                                <td>{{ entry.timestamp|format_datetime }}</td>
                                <td>
                                    {% if entry.action == 'created' %}
                                        <span class="badge bg-success">Angelegt</span>
                                    {% elif entry.action == 'updated' %}
                                        <span class="badge bg-info">Aktualisiert</span>
                                    {% elif entry.action == 'deleted' %}
                                        <span class="badge bg-danger">Gelöscht</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ entry.action }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ entry.details }}</td>
                                <td>{{ entry.user }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">Keine Historie vorhanden</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Löschen Bestätigung -->
<form id="deleteForm" method="POST" action="{{ url_for('customers.delete', customer_id=customer.id) }}" style="display: none;">
</form>

<script>
function confirmDelete() {
    if (confirm('Möchten Sie diesen Kunden wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) {
        document.getElementById('deleteForm').submit();
    }
}
</script>
{% endblock %}