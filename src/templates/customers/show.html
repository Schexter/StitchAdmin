{% extends "base.html" %}

{% block title %}{{ customer.display_name or (customer.first_name ~ ' ' ~ customer.last_name) or customer.company_name }} - Kundendetails{% endblock %}

{% block content %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="row">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('customers.index') }}">Kunden</a></li>
                <li class="breadcrumb-item active">
                    {{ customer.display_name or (customer.first_name ~ ' ' ~ customer.last_name) or customer.company_name }}
                </li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                {% if customer.get('customer_type', 'private') == 'business' %}
                    <i class="bi bi-building"></i>
                {% else %}
                    <i class="bi bi-person-fill"></i>
                {% endif %}
                {{ customer.display_name or (customer.first_name ~ ' ' ~ customer.last_name) or customer.company_name }}
            </h1>
            <div>
                <a href="{{ url_for('orders.new', customer_id=customer.id) }}" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Neuer Auftrag
                </a>
                <a href="{{ url_for('customers.edit', customer_id=customer.id) }}" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Bearbeiten
                </a>
                <button class="btn btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash"></i> Löschen
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Persönliche/Firmen Daten -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    {% if customer.get('customer_type', 'private') == 'business' %}
                        Firmendaten
                    {% else %}
                        Persönliche Daten
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Kunden-Nr:</strong></div>
                    <div class="col-md-9">{{ customer.id }}</div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Kundentyp:</strong></div>
                    <div class="col-md-9">
                        {% if customer.get('customer_type', 'private') == 'business' %}
                            <span class="badge bg-info">Firmenkunde</span>
                        {% else %}
                            <span class="badge bg-success">Privatperson</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if customer.get('customer_type', 'private') == 'business' %}
                    <!-- Firmenkunden-Felder -->
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>Firmenname:</strong></div>
                        <div class="col-md-9">{{ customer.company_name }}</div>
                    </div>
                    
                    {% if customer.tax_id %}
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>Steuernummer:</strong></div>
                        <div class="col-md-9">{{ customer.tax_id }}</div>
                    </div>
                    {% endif %}
                    
                    {% if customer.vat_id %}
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>USt-ID:</strong></div>
                        <div class="col-md-9">{{ customer.vat_id }}</div>
                    </div>
                    {% endif %}
                    
                    {% if customer.contact_person %}
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>Ansprechpartner:</strong></div>
                        <div class="col-md-9">
                            {{ customer.contact_person }}
                            {% if customer.department %}
                                <br><small class="text-muted">{{ customer.department }}</small>
                            {% endif %}
                            {% if customer.position %}
                                <br><small class="text-muted">{{ customer.position }}</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% else %}
                    <!-- Privatpersonen-Felder -->
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>Name:</strong></div>
                        <div class="col-md-9">{{ customer.first_name }} {{ customer.last_name }}</div>
                    </div>
                    
                    {% if customer.birth_date %}
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>Geburtsdatum:</strong></div>
                        <div class="col-md-9">
                            {{ customer.birth_date|format_date }}
                            {% if customer.birth_date %}
                                {% set age = customer.birth_date|calculate_age %}
                                {% if age is not none %}
                                    <small class="text-muted">({{ age }} Jahre)</small>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% endif %}
                
                <div class="row mb-2">
                    <div class="col-md-3"><strong>E-Mail:</strong></div>
                    <div class="col-md-9">
                        {% if customer.email %}
                            <a href="mailto:{{ customer.email }}">{{ customer.email }}</a>
                        {% else %}
                            -
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Kontaktdaten -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Kontaktdaten</h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Telefon:</strong></div>
                    <div class="col-md-9">
                        {% if customer.phone %}
                            <a href="tel:{{ customer.phone }}">{{ customer.phone }}</a>
                        {% else %}
                            -
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Mobil:</strong></div>
                    <div class="col-md-9">
                        {% if customer.mobile %}
                            <a href="tel:{{ customer.mobile }}">{{ customer.mobile }}</a>
                        {% else %}
                            -
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Adresse -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Adresse</h5>
            </div>
            <div class="card-body">
                {% if customer.street or customer.city %}
                <address>
                    {% if customer.street %}
                        {{ customer.street }} {{ customer.house_number }}<br>
                    {% endif %}
                    {% if customer.postal_code or customer.city %}
                        {{ customer.postal_code }} {{ customer.city }}<br>
                    {% endif %}
                    {{ customer.country or 'Deutschland' }}
                </address>
                {% else %}
                <p class="text-muted">Keine Adresse hinterlegt</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Status</h5>
            </div>
            <div class="card-body">
                <p>
                    <strong>Newsletter:</strong> 
                    {% if customer.newsletter %}
                        <span class="badge bg-success">Abonniert</span>
                    {% else %}
                        <span class="badge bg-secondary">Nicht abonniert</span>
                    {% endif %}
                </p>
                <p>
                    <strong>Kunde seit:</strong><br>
                    {{ customer.created_at|format_date or 'Unbekannt' }}
                </p>
                {% if customer.updated_at %}
                <p>
                    <small class="text-muted">
                        Zuletzt aktualisiert: {{ customer.updated_at|format_date }}
                        {% if customer.updated_by %}
                            von {{ customer.updated_by }}
                        {% endif %}
                    </small>
                </p>
                {% endif %}
            </div>
        </div>
        
        <!-- Notizen -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Notizen</h5>
            </div>
            <div class="card-body">
                {% if customer.notes %}
                    <p>{{ customer.notes|nl2br }}</p>
                {% else %}
                    <p class="text-muted">Keine Notizen vorhanden</p>
                {% endif %}
            </div>
        </div>
        
        <!-- CRM - Kontakt -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-chat-dots"></i> Kontakt</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if customer.email %}
                    <a href="{{ url_for('crm.send_email', customer_id=customer.id) }}" class="btn btn-primary">
                        <i class="bi bi-envelope"></i> E-Mail schreiben
                    </a>
                    {% endif %}
                    {% if customer.phone or customer.mobile %}
                    <a href="{{ url_for('crm.phone_note', customer_id=customer.id) }}" class="btn btn-success">
                        <i class="bi bi-telephone"></i> Telefon-Notiz
                    </a>
                    {% endif %}
                    <a href="{{ url_for('crm.customer_contacts', customer_id=customer.id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-clock-history"></i> Kontakthistorie
                    </a>
                </div>
            </div>
        </div>

        <!-- Schnellaktionen -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Schnellaktionen</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('orders.new') }}?customer_id={{ customer.id }}" class="btn btn-success">
                        <i class="bi bi-plus-circle"></i> Neuer Auftrag
                    </a>
                    {% if customer.get('customer_type', 'private') == 'business' %}
                    <a href="{{ url_for('rechnung.neue_rechnung') }}?kunde_id={{ customer.id }}" class="btn btn-outline-primary">
                        <i class="bi bi-receipt"></i> Neue Rechnung
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Aufträge des Kunden -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Aufträge ({{ orders|length }})</h5>
                <a href="{{ url_for('orders.new') }}?customer_id={{ customer.id }}" class="btn btn-sm btn-success">
                    <i class="bi bi-plus-circle"></i> Neuer Auftrag
                </a>
            </div>
            <div class="card-body">
                {% if orders %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Auftragsnr.</th>
                                <th>Beschreibung</th>
                                <th>Typ</th>
                                <th>Status</th>
                                <th>Erstellt</th>
                                <th>Fällig</th>
                                <th>Preis</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('orders.show', order_id=order.id) }}" class="text-decoration-none">
                                        <strong>{{ order.order_number }}</strong>
                                    </a>
                                </td>
                                <td>{{ order.description[:50] }}{% if order.description and order.description|length > 50 %}...{% endif %}</td>
                                <td>
                                    {% if order.order_type == 'embroidery' %}
                                        <span class="badge bg-primary">Stickerei</span>
                                    {% elif order.order_type == 'printing' %}
                                        <span class="badge bg-info">Druck</span>
                                    {% elif order.order_type == 'dtf' %}
                                        <span class="badge bg-warning">DTF</span>
                                    {% elif order.order_type == 'combined' %}
                                        <span class="badge bg-secondary">Kombiniert</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">{{ order.order_type or '-' }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if order.status == 'new' or order.status == 'pending' %}
                                        <span class="badge bg-secondary">Neu</span>
                                    {% elif order.status == 'approved' %}
                                        <span class="badge bg-info">Freigegeben</span>
                                    {% elif order.status == 'in_progress' %}
                                        <span class="badge bg-warning">In Bearbeitung</span>
                                    {% elif order.status == 'ready' or order.status == 'ready_for_pickup' %}
                                        <span class="badge bg-success">Fertig</span>
                                    {% elif order.status == 'completed' %}
                                        <span class="badge bg-dark">Abgeschlossen</span>
                                    {% elif order.status == 'cancelled' %}
                                        <span class="badge bg-danger">Storniert</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">{{ order.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ order.created_at|format_date if order.created_at else '-' }}</td>
                                <td>
                                    {% if order.due_date %}
                                        {{ order.due_date|format_date }}
                                        {% if order.rush_order %}
                                            <span class="badge bg-danger ms-1">Eilauftrag</span>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td><strong>{{ order.total_price|format_currency if order.total_price else '-' }}</strong></td>
                                <td>
                                    <a href="{{ url_for('orders.show', order_id=order.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> Details
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">
                    <i class="bi bi-inbox fs-1"></i><br>
                    Noch keine Aufträge für diesen Kunden vorhanden.
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Hochgeladene Dateien / Logos -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-file-earmark-image"></i> Design-Dateien & Logos</h5>
            </div>
            <div class="card-body">
                {% set files_found = [] %}
                {% for order in orders %}
                    {% if order.design_file or order.design_file_path or order.design_thumbnail_path or order.production_file %}
                        {% set _ = files_found.append(order) %}
                    {% endif %}
                {% endfor %}

                {% if files_found %}
                <div class="row">
                    {% for order in files_found %}
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <a href="{{ url_for('orders.show', order_id=order.id) }}" class="text-decoration-none">
                                        {{ order.order_number }}
                                    </a>
                                    <small class="text-muted">- {{ order.description[:30] if order.description else 'Kein Titel' }}</small>
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if order.design_thumbnail_path %}
                                <div class="mb-3 text-center">
                                    <img src="{{ url_for('static', filename=order.design_thumbnail_path) }}"
                                         alt="Thumbnail"
                                         class="img-thumbnail"
                                         style="max-height: 200px;">
                                </div>
                                {% endif %}

                                <div class="list-group list-group-flush">
                                    {% if order.design_file %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-file-earmark-text text-primary"></i>
                                            <strong>Design-Datei:</strong>
                                        </div>
                                        <div class="text-end">
                                            <code class="small">{{ order.design_file }}</code>
                                            {% if order.design_file_path %}
                                            <br><a href="{{ url_for('static', filename=order.design_file_path) }}"
                                                   target="_blank"
                                                   class="btn btn-sm btn-outline-primary mt-1">
                                                <i class="bi bi-download"></i> Download
                                            </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if order.design_file_path and not order.design_file %}
                                    <div class="list-group-item">
                                        <i class="bi bi-folder text-warning"></i>
                                        <strong>Pfad:</strong>
                                        <br><code class="small">{{ order.design_file_path }}</code>
                                        <br><a href="{{ url_for('static', filename=order.design_file_path) }}"
                                               target="_blank"
                                               class="btn btn-sm btn-outline-primary mt-1">
                                            <i class="bi bi-download"></i> Anzeigen
                                        </a>
                                    </div>
                                    {% endif %}

                                    {% if order.production_file %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-file-earmark-check text-success"></i>
                                            <strong>Produktionsdatei:</strong>
                                        </div>
                                        <div class="text-end">
                                            <code class="small">{{ order.production_file }}</code>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center py-4">
                    <i class="bi bi-inbox fs-1"></i><br>
                    Noch keine Dateien für diesen Kunden hochgeladen.
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Kunden-Historie -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Historie</h5>
            </div>
            <div class="card-body">
                {% if history %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Aktion</th>
                                <th>Details</th>
                                <th>Benutzer</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in history %}
                            <tr>
                                <td>{{ entry.timestamp|format_datetime }}</td>
                                <td>
                                    {% if entry.action == 'created' %}
                                        <span class="badge bg-success">Angelegt</span>
                                    {% elif entry.action == 'updated' %}
                                        <span class="badge bg-info">Aktualisiert</span>
                                    {% elif entry.action == 'deleted' %}
                                        <span class="badge bg-danger">Gelöscht</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ entry.action }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ entry.details }}</td>
                                <td>{{ entry.user }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">Keine Historie vorhanden</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Löschen Bestätigung -->
<form id="deleteForm" method="POST" action="{{ url_for('customers.delete', customer_id=customer.id) }}" style="display: none;">
</form>

<script>
function confirmDelete() {
    if (confirm('Möchten Sie diesen Kunden wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) {
        document.getElementById('deleteForm').submit();
    }
}
</script>
{% endblock %}