{% extends "base.html" %}
{% block title %}Rechnung {{ rechnung.dokument_nummer }} bearbeiten{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="{{ url_for('rechnungen.index') }}">Rechnungen</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('rechnungen.show', id=rechnung.id) }}">{{ rechnung.dokument_nummer }}</a></li>
                <li class="breadcrumb-item active">Bearbeiten</li>
            </ol>
        </nav>
        <h2><i class="fas fa-edit text-warning me-2"></i>Rechnung bearbeiten</h2>
    </div>

    <form method="POST" id="rechnungForm">
        <input type="hidden" name="positionen_json" id="positionenJson">
        
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light"><h5 class="mb-0">Kunde</h5></div>
                    <div class="card-body"><h5>{{ rechnung.kunde.display_name if rechnung.kunde else '-' }}</h5></div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light"><h5 class="mb-0">Details</h5></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Leistungsdatum</label>
                            <input type="date" name="leistungsdatum" class="form-control" 
                                   value="{{ rechnung.leistungsdatum.strftime('%Y-%m-%d') if rechnung.leistungsdatum else '' }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Betreff</label>
                            <input type="text" name="betreff" class="form-control" value="{{ rechnung.betreff or '' }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Einleitung</label>
                            <textarea name="einleitung" class="form-control" rows="2">{{ rechnung.einleitung or '' }}</textarea>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Positionen</h5>
                        <button type="button" class="btn btn-success btn-sm" onclick="neuePosition()"><i class="fas fa-plus me-1"></i> Position</button>
                    </div>
                    <div class="card-body p-0">
                        <table class="table mb-0" id="positionenTabelle">
                            <thead class="table-light"><tr><th>Pos.</th><th>Bezeichnung</th><th>Menge</th><th>Preis</th><th>Gesamt</th><th></th></tr></thead>
                            <tbody id="positionenBody"></tbody>
                            <tfoot class="table-light"><tr><td colspan="4" class="text-end"><strong>Netto:</strong></td><td class="text-end"><strong id="summeNetto">0,00 €</strong></td><td></td></tr></tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-secondary text-white"><h5 class="mb-0">Zusammenfassung</h5></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Interne Notiz</label>
                            <textarea name="interne_notiz" class="form-control" rows="2">{{ rechnung.interne_notiz or '' }}</textarea>
                        </div>
                        <hr>
                        <div class="mb-2 d-flex justify-content-between"><span>Netto:</span><strong id="summeNettoSidebar">0,00 €</strong></div>
                        <div class="mb-2 d-flex justify-content-between text-muted"><span>MwSt.:</span><span id="summeMwst">0,00 €</span></div>
                        <div class="mb-3 d-flex justify-content-between fs-5"><strong>Gesamt:</strong><strong class="text-success" id="summeBrutto">0,00 €</strong></div>
                        <hr>
                        <button type="submit" class="btn btn-warning w-100 mb-2"><i class="fas fa-save me-1"></i> Speichern</button>
                        <a href="{{ url_for('rechnungen.show', id=rechnung.id) }}" class="btn btn-outline-secondary w-100">Abbrechen</a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="modal fade" id="positionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Position</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3"><label class="form-label fw-bold">Bezeichnung *</label><input type="text" class="form-control" id="posBezeichnung"></div>
                <div class="row">
                    <div class="col-4 mb-3"><label class="form-label">Menge</label><input type="number" class="form-control" id="posMenge" value="1" min="0.01" step="0.01"></div>
                    <div class="col-4 mb-3"><label class="form-label">Einheit</label><select class="form-select" id="posEinheit"><option value="Stk.">Stk.</option><option value="Std.">Std.</option></select></div>
                    <div class="col-4 mb-3"><label class="form-label">Preis</label><input type="number" class="form-control" id="posEinzelpreis" value="0" step="0.01"></div>
                </div>
                <input type="hidden" id="posEditIndex" value="-1">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-success" onclick="positionSpeichern()">Übernehmen</button>
            </div>
        </div>
    </div>
</div>

<script>
let positionen = [
    {% for pos in rechnung.positionen %}
    {bezeichnung: {{ pos.bezeichnung|tojson }}, menge: {{ pos.menge }}, einheit: {{ pos.einheit|tojson }}, einzelpreis: {{ pos.einzelpreis_netto }}, mwst_satz: 19, typ: 'artikel'}{% if not loop.last %},{% endif %}
    {% endfor %}
];

document.getElementById('rechnungForm').addEventListener('submit', function(e) {
    document.getElementById('positionenJson').value = JSON.stringify(positionen);
});

function neuePosition() {
    document.getElementById('posBezeichnung').value = '';
    document.getElementById('posMenge').value = '1';
    document.getElementById('posEinheit').value = 'Stk.';
    document.getElementById('posEinzelpreis').value = '0';
    document.getElementById('posEditIndex').value = '-1';
    new bootstrap.Modal(document.getElementById('positionModal')).show();
}

function positionBearbeiten(idx) {
    const p = positionen[idx];
    document.getElementById('posBezeichnung').value = p.bezeichnung;
    document.getElementById('posMenge').value = p.menge;
    document.getElementById('posEinheit').value = p.einheit;
    document.getElementById('posEinzelpreis').value = p.einzelpreis;
    document.getElementById('posEditIndex').value = idx;
    new bootstrap.Modal(document.getElementById('positionModal')).show();
}

function positionSpeichern() {
    const bez = document.getElementById('posBezeichnung').value.trim();
    if (!bez) { alert('Bezeichnung erforderlich'); return; }
    const pos = {
        bezeichnung: bez,
        menge: parseFloat(document.getElementById('posMenge').value) || 1,
        einheit: document.getElementById('posEinheit').value,
        einzelpreis: parseFloat(document.getElementById('posEinzelpreis').value) || 0,
        mwst_satz: 19, typ: 'artikel'
    };
    const idx = parseInt(document.getElementById('posEditIndex').value);
    if (idx >= 0) positionen[idx] = pos; else positionen.push(pos);
    render();
    bootstrap.Modal.getInstance(document.getElementById('positionModal')).hide();
}

function positionEntfernen(idx) { positionen.splice(idx, 1); render(); }

function render() {
    const tbody = document.getElementById('positionenBody');
    tbody.innerHTML = positionen.map((p, i) => {
        const ges = p.menge * p.einzelpreis;
        return `<tr><td>${i+1}</td><td><strong>${p.bezeichnung}</strong></td><td>${p.menge} ${p.einheit}</td><td class="text-end">${p.einzelpreis.toFixed(2)} €</td><td class="text-end"><strong>${ges.toFixed(2)} €</strong></td><td><button type="button" class="btn btn-sm btn-outline-secondary" onclick="positionBearbeiten(${i})"><i class="fas fa-edit"></i></button> <button type="button" class="btn btn-sm btn-outline-danger" onclick="positionEntfernen(${i})"><i class="fas fa-trash"></i></button></td></tr>`;
    }).join('');
    berechneSummen();
}

function berechneSummen() {
    let netto = 0; positionen.forEach(p => netto += p.menge * p.einzelpreis);
    const mwst = netto * 0.19, brutto = netto + mwst;
    const fmt = v => v.toFixed(2).replace('.', ',') + ' €';
    document.getElementById('summeNetto').textContent = fmt(netto);
    document.getElementById('summeNettoSidebar').textContent = fmt(netto);
    document.getElementById('summeMwst').textContent = fmt(mwst);
    document.getElementById('summeBrutto').textContent = fmt(brutto);
}
render();
</script>
{% endblock %}
