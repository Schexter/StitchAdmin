{% extends "base.html" %}

{% block title %}Wareneingang - {{ order.order_number }} - StitchAdmin{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="row">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('suppliers.index') }}">Lieferanten</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('suppliers.show', supplier_id=supplier.id) }}">{{ supplier.name }}</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('suppliers.show_order', supplier_id=supplier.id, order_id=order.id) }}">{{ order.order_number }}</a></li>
                <li class="breadcrumb-item active">Wareneingang</li>
            </ol>
        </nav>

        <h1 class="mb-4">
            <i class="bi bi-box-seam"></i> Wareneingang - {{ order.order_number }}
        </h1>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Lieferung von {{ supplier.name }} einbuchen</h5>
    </div>
    <div class="card-body">
        <form method="POST">
            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle"></i>
                Markieren Sie alle erhaltenen Artikel und geben Sie die tatsächlich gelieferte Menge ein.
                Bei Teillieferungen können Sie später weitere Eingänge buchen.
            </div>

            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="width: 50px;">
                            <input type="checkbox" class="form-check-input" id="select-all" onchange="toggleAll(this)">
                        </th>
                        <th>Artikel</th>
                        <th>Bestellt</th>
                        <th>Bereits erhalten</th>
                        <th>Jetzt erhalten</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input item-checkbox"
                                   name="received_item" value="{{ item.article_number }}"
                                   {% if item.received_quantity|default(0) >= item.quantity %}disabled{% endif %}>
                        </td>
                        <td>
                            <strong>{{ item.description }}</strong><br>
                            <small class="text-muted">
                                Art.-Nr: {{ item.article_number }}
                                {% if item.supplier_article_number %} | Lief.-Nr: {{ item.supplier_article_number }}{% endif %}
                            </small>
                        </td>
                        <td>{{ item.quantity }} {{ item.unit or 'Stk' }}</td>
                        <td>
                            {% set received = item.received_quantity|default(0) %}
                            {% if received >= item.quantity %}
                                <span class="badge bg-success">{{ received }} - Vollständig</span>
                            {% elif received > 0 %}
                                <span class="badge bg-warning">{{ received }} von {{ item.quantity }}</span>
                            {% else %}
                                <span class="badge bg-secondary">0</span>
                            {% endif %}
                        </td>
                        <td style="width: 150px;">
                            {% set remaining = item.quantity - item.received_quantity|default(0) %}
                            {% if remaining > 0 %}
                            <input type="number" class="form-control"
                                   name="received_qty_{{ item.article_number }}"
                                   value="{{ remaining }}" min="0" max="{{ remaining }}">
                            {% else %}
                            <span class="text-success"><i class="bi bi-check-circle"></i> Komplett</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Lieferschein-Nr. (optional)</label>
                        <input type="text" class="form-control" name="delivery_note_number"
                               placeholder="Lieferscheinnummer des Lieferanten">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Anmerkungen (optional)</label>
                        <textarea class="form-control" name="notes" rows="2"
                                  placeholder="Bemerkungen zur Lieferung..."></textarea>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between">
                <a href="{{ url_for('suppliers.show_order', supplier_id=supplier.id, order_id=order.id) }}"
                   class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Zurück
                </a>
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="bi bi-box-seam"></i> Wareneingang buchen
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function toggleAll(checkbox) {
    document.querySelectorAll('.item-checkbox:not(:disabled)').forEach(cb => {
        cb.checked = checkbox.checked;
    });
}
</script>
{% endblock %}
