{% extends "base.html" %}

{% block title %}{{ machine.name }} - Garnkonfiguration{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">üßµ {{ machine.name }} - Garnkonfiguration</h1>
                <div>
                    <a href="{{ url_for('machines.show', machine_id=machine.id) }}" class="btn btn-secondary btn-touch me-2">
                        <i class="fas fa-arrow-left"></i> Zur√ºck
                    </a>
                    <a href="{{ url_for('thread.index') }}" class="btn btn-outline-info btn-touch">
                        <i class="fas fa-palette"></i> Garnverwaltung
                    </a>
                </div>
            </div>

            {% if machine.thread_setup_updated %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 
                Letzte Aktualisierung: {{ machine.thread_setup_updated[:16].replace('T', ' ') }} 
                von {{ machine.thread_setup_updated_by }}
            </div>
            {% endif %}

            <form method="POST">
                <!-- Hilfreich: Zeige verf√ºgbare Garne an -->
                {% if not available_threads %}
                <div class="alert alert-warning mb-4">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>Keine Garne geladen!</strong> 
                    Bitte pr√ºfen Sie die <a href="{{ url_for('thread.index') }}" class="alert-link">Garnverwaltung</a> 
                    und stellen Sie sicher, dass Garne mit Bestand vorhanden sind.
                </div>
                {% else %}
                <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
                    <i class="fas fa-info-circle"></i> 
                    <strong>{{ available_threads|length }} Garne verf√ºgbar.</strong> 
                    Verwenden Sie die <i class="fas fa-search"></i> Suchfunktion neben jedem Dropdown f√ºr eine schnelle Auswahl.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
                
                <div class="row">
                    {% for head_num in range(machine.num_heads or 1) %}
                    <div class="col-lg-{{ 12 // (machine.num_heads or 1) if (machine.num_heads or 1) <= 3 else 4 }} mb-4">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-cog"></i> Stickkopf {{ head_num + 1 }}
                                    <small class="ms-2">({{ machine.needles_per_head or 15 }} Nadeln)</small>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% for needle_num in range(machine.needles_per_head or 15) %}
                                    {% set current_thread = None %}
                                    {% if machine.thread_setup %}
                                        {% for head_setup in machine.thread_setup %}
                                            {% if head_setup.head_number == head_num + 1 %}
                                                {% for thread_info in head_setup.threads %}
                                                    {% if thread_info.needle_position == needle_num + 1 %}
                                                        {% set current_thread = thread_info.thread_id %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}

                                    <div class="col-md-6 col-lg-{{ 12 if (machine.needles_per_head or 15) <= 6 else 6 if (machine.needles_per_head or 15) <= 12 else 4 }} mb-3">
                                        <label for="head_{{ head_num }}_needle_{{ needle_num }}_thread" class="form-label small">
                                            <strong>Nadel {{ needle_num + 1 }}</strong>
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <select class="form-select form-select-sm thread-select" 
                                                    id="head_{{ head_num }}_needle_{{ needle_num }}_thread" 
                                                    name="head_{{ head_num }}_needle_{{ needle_num }}_thread"
                                                    onchange="updateThreadPreview(this, {{ head_num }}, {{ needle_num }})">
                                                <option value="">Leer</option>
                                                {% for thread_id, thread in available_threads.items() | sort(attribute='1.brand') %}
                                                <option value="{{ thread_id }}" 
                                                        data-color="{{ thread.color_hex }}"
                                                        data-name="{{ thread.color_name }}"
                                                        data-search="{{ thread.brand|lower }} {{ thread.color_code|lower }} {{ thread.color_name|lower }}"
                                                        {{ 'selected' if current_thread == thread_id }}>
                                                    {{ thread.brand }}-{{ thread.color_code }} 
                                                    {% if thread.color_name %}({{ thread.color_name }}){% endif %}
                                                    - {{ thread.stock }} Konen
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <button class="btn btn-outline-secondary btn-sm" type="button" 
                                                    onclick="openThreadSearchModal({{ head_num }}, {{ needle_num }})" 
                                                    title="Garn suchen">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Farbvorschau -->
                                        <div class="mt-1 d-flex align-items-center">
                                            <div id="color_preview_{{ head_num }}_{{ needle_num }}" 
                                                 class="color-preview me-2" 
                                                 style="width: 20px; height: 20px; border: 1px solid #ccc; border-radius: 3px; 
                                                        background-color: {% if current_thread %}{{ available_threads[current_thread].color_hex if current_thread in available_threads }}{% else %}#f8f9fa{% endif %};">
                                            </div>
                                            <small id="thread_info_{{ head_num }}_{{ needle_num }}" class="text-muted">
                                                {% if current_thread and current_thread in available_threads %}
                                                {{ available_threads[current_thread].color_name or 'Unbenannt' }}
                                                {% else %}
                                                Kein Garn
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                                <!-- Schnellaktionen f√ºr diesen Kopf -->
                                <div class="mt-3 border-top pt-3">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-secondary" 
                                                onclick="clearHead({{ head_num }})">
                                            <i class="fas fa-eraser"></i> Alle leeren
                                        </button>
                                        <button type="button" class="btn btn-outline-info" 
                                                onclick="copyHead({{ head_num }})">
                                            <i class="fas fa-copy"></i> Kopieren
                                        </button>
                                        {% if head_num > 0 %}
                                        <button type="button" class="btn btn-outline-success" 
                                                onclick="pasteHead({{ head_num }})">
                                            <i class="fas fa-paste"></i> Einf√ºgen
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Aktuelle Garnkonfiguration -->
                {% if machine.thread_setup %}
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Aktuelle Garnkonfiguration</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Kopf</th>
                                                <th>Nadel</th>
                                                <th>Garn</th>
                                                <th>Farbe</th>
                                                <th>Bestand</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for head_setup in machine.thread_setup %}
                                            {% for thread_info in head_setup.threads %}
                                            {% set thread = available_threads.get(thread_info.thread_id) %}
                                            <tr>
                                                <td>{{ head_setup.head_number }}</td>
                                                <td>{{ thread_info.needle_position }}</td>
                                                <td>
                                                    {% if thread %}
                                                    {{ thread.brand }}-{{ thread.color_code }}
                                                    {% else %}
                                                    <span class="text-danger">{{ thread_info.thread_id }} (nicht verf√ºgbar)</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if thread %}
                                                    <div class="d-flex align-items-center">
                                                        <div class="color-sample me-2" 
                                                             style="width: 15px; height: 15px; background-color: {{ thread.color_hex }}; border: 1px solid #ccc; border-radius: 2px;"></div>
                                                        {{ thread.color_name or 'Unbenannt' }}
                                                    </div>
                                                    {% else %}
                                                    -
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if thread %}
                                                    <span class="{{ 'text-danger' if thread.stock <= 1 else 'text-warning' if thread.stock <= 3 else 'text-success' }}">
                                                        {{ thread.stock }} Konen
                                                    </span>
                                                    {% else %}
                                                    -
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="d-flex justify-content-between mt-4">
                    <a href="{{ url_for('machines.show', machine_id=machine.id) }}" class="btn btn-secondary btn-touch">
                        <i class="fas fa-times"></i> Abbrechen
                    </a>
                    <button type="submit" class="btn btn-success btn-touch">
                        <i class="fas fa-save"></i> Garnkonfiguration speichern
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let copiedHeadData = null;

function updateThreadPreview(selectElement, headNum, needleNum) {
    const selectedOption = selectElement.selectedOptions[0];
    const colorPreview = document.getElementById(`color_preview_${headNum}_${needleNum}`);
    const threadInfo = document.getElementById(`thread_info_${headNum}_${needleNum}`);
    
    if (selectedOption.value) {
        const color = selectedOption.dataset.color || '#f8f9fa';
        const name = selectedOption.dataset.name || 'Unbenannt';
        
        colorPreview.style.backgroundColor = color;
        threadInfo.textContent = name;
    } else {
        colorPreview.style.backgroundColor = '#f8f9fa';
        threadInfo.textContent = 'Kein Garn';
    }
}

function clearHead(headNum) {
    if (confirm(`M√∂chten Sie alle Garne von Kopf ${headNum + 1} entfernen?`)) {
        const needlesPerHead = {{ machine.needles_per_head or 15 }};
        for (let needle = 0; needle < needlesPerHead; needle++) {
            const select = document.getElementById(`head_${headNum}_needle_${needle}_thread`);
            if (select) {
                select.value = '';
                updateThreadPreview(select, headNum, needle);
            }
        }
    }
}

function copyHead(headNum) {
    const needlesPerHead = {{ machine.needles_per_head or 15 }};
    copiedHeadData = [];
    
    for (let needle = 0; needle < needlesPerHead; needle++) {
        const select = document.getElementById(`head_${headNum}_needle_${needle}_thread`);
        if (select) {
            copiedHeadData.push(select.value);
        }
    }
    
    // Feedback
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i> Kopiert!';
    btn.classList.remove('btn-outline-info');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-info');
    }, 1000);
}

function pasteHead(headNum) {
    if (!copiedHeadData) {
        alert('Kopieren Sie zuerst einen anderen Kopf.');
        return;
    }
    
    if (confirm(`M√∂chten Sie die kopierten Garne in Kopf ${headNum + 1} einf√ºgen?`)) {
        for (let needle = 0; needle < copiedHeadData.length; needle++) {
            const select = document.getElementById(`head_${headNum}_needle_${needle}_thread`);
            if (select) {
                select.value = copiedHeadData[needle];
                updateThreadPreview(select, headNum, needle);
            }
        }
    }
}

// Initial preview update
document.addEventListener('DOMContentLoaded', function() {
    const numHeads = {{ machine.num_heads or 1 }};
    const needlesPerHead = {{ machine.needles_per_head or 15 }};
    
    for (let head = 0; head < numHeads; head++) {
        for (let needle = 0; needle < needlesPerHead; needle++) {
            const select = document.getElementById(`head_${head}_needle_${needle}_thread`);
            if (select && select.value) {
                updateThreadPreview(select, head, needle);
            }
        }
    }
});
// Thread-Suche Modal
function openThreadSearchModal(headNum, needleNum) {
    const modal = new bootstrap.Modal(document.getElementById('threadSearchModal'));
    document.getElementById('searchModalHeadNum').value = headNum;
    document.getElementById('searchModalNeedleNum').value = needleNum;
    document.getElementById('threadSearchInput').value = '';
    
    // Event listener f√ºr Modal shown
    document.getElementById('threadSearchModal').addEventListener('shown.bs.modal', function () {
        document.getElementById('threadSearchInput').focus();
    }, { once: true });
    
    filterThreadOptions();
    modal.show();
}

function filterThreadOptions() {
    const searchValue = document.getElementById('threadSearchInput').value.toLowerCase();
    const threadList = document.getElementById('threadSearchResults');
    threadList.innerHTML = '';
    
    const availableThreads = [
        {% for thread_id, thread in available_threads.items() | sort(attribute='1.brand') %}
        {
            id: '{{ thread_id }}',
            brand: '{{ thread.brand }}',
            colorCode: '{{ thread.color_code }}',
            colorName: '{{ thread.color_name }}',
            colorHex: '{{ thread.color_hex }}',
            stock: {{ thread.stock }}
        },
        {% endfor %}
    ];
    
    const filteredThreads = availableThreads.filter(thread => {
        const searchString = `${thread.brand} ${thread.colorCode} ${thread.colorName}`.toLowerCase();
        return searchString.includes(searchValue);
    });
    
    filteredThreads.forEach(thread => {
        const div = document.createElement('div');
        div.className = 'list-group-item list-group-item-action d-flex align-items-center';
        div.style.cursor = 'pointer';
        div.onclick = () => selectThreadFromSearch(thread.id);
        
        div.innerHTML = `
            <div class="color-preview me-2" style="width: 30px; height: 30px; background-color: ${thread.colorHex}; border: 1px solid #ccc; border-radius: 3px;"></div>
            <div class="flex-grow-1">
                <strong>${thread.brand}-${thread.colorCode}</strong>
                ${thread.colorName ? `<br><small class="text-muted">${thread.colorName}</small>` : ''}
            </div>
            <div>
                <span class="badge ${thread.stock > 5 ? 'bg-success' : thread.stock > 0 ? 'bg-warning' : 'bg-danger'}">
                    ${thread.stock} Konen
                </span>
            </div>
        `;
        
        threadList.appendChild(div);
    });
    
    if (filteredThreads.length === 0) {
        threadList.innerHTML = '<div class="list-group-item text-muted text-center">Keine Garne gefunden</div>';
    }
}

function selectThreadFromSearch(threadId) {
    const headNum = document.getElementById('searchModalHeadNum').value;
    const needleNum = document.getElementById('searchModalNeedleNum').value;
    const select = document.getElementById(`head_${headNum}_needle_${needleNum}_thread`);
    
    select.value = threadId;
    updateThreadPreview(select, parseInt(headNum), parseInt(needleNum));
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('threadSearchModal'));
    modal.hide();
}
</script>

<style>
.color-preview {
    display: inline-block;
    flex-shrink: 0;
}

.form-select-sm {
    font-size: 0.85rem;
}

.card-header.bg-primary {
    background-color: #0d6efd !important;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.4rem;
    font-size: 0.75rem;
}
</style>

<!-- Thread Search Modal -->
<div class="modal fade" id="threadSearchModal" tabindex="-1" aria-labelledby="threadSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="threadSearchModalLabel">
                    <i class="fas fa-search"></i> Garn suchen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="searchModalHeadNum">
                <input type="hidden" id="searchModalNeedleNum">
                
                <div class="mb-3">
                    <input type="text" class="form-control" id="threadSearchInput" 
                           placeholder="Suche nach Marke, Farbnummer oder Farbname..." 
                           onkeyup="filterThreadOptions()" autofocus>
                </div>
                
                <div class="list-group" id="threadSearchResults" style="max-height: 400px; overflow-y: auto;">
                    <!-- Suchergebnisse werden hier eingef√ºgt -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}