{% extends "base.html" %}

{% block title %}Garn-Übersicht {{ machine.name }} - StitchAdmin{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="bi bi-gear-fill"></i> Garn-Übersicht: {{ machine.name }}
            </h1>
            <div>
                <a href="{{ url_for('machines.show', machine_id=machine.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Zur Maschine
                </a>
                <a href="{{ url_for('machines.index') }}" class="btn btn-outline-primary">
                    <i class="bi bi-list"></i> Alle Maschinen
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Maschinen-Info -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Typ:</strong> {{ machine.type or 'Unbekannt' }}
                    </div>
                    <div class="col-md-3">
                        <strong>Hersteller:</strong> {{ machine.manufacturer or '-' }}
                    </div>
                    <div class="col-md-3">
                        <strong>Modell:</strong> {{ machine.model or '-' }}
                    </div>
                    <div class="col-md-3">
                        <strong>Gesamt-Verbrauch:</strong> <span class="badge bg-primary">{{ "%.1f"|format(total_usage) }}m</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Zeitraum-Filter -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="btn-group" role="group">
            <a href="{{ url_for('machines.machine_threads', machine_id=machine.id, period='7') }}"
               class="btn btn-sm btn-outline-primary {% if period == '7' %}active{% endif %}">
                Letzte 7 Tage
            </a>
            <a href="{{ url_for('machines.machine_threads', machine_id=machine.id, period='30') }}"
               class="btn btn-sm btn-outline-primary {% if period == '30' %}active{% endif %}">
                Letzte 30 Tage
            </a>
            <a href="{{ url_for('machines.machine_threads', machine_id=machine.id, period='90') }}"
               class="btn btn-sm btn-outline-primary {% if period == '90' %}active{% endif %}">
                Letzte 90 Tage
            </a>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Garnverbrauch (Historisch) -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Verwendete Garne ({{ period }} Tage)</h5>
            </div>
            <div class="card-body">
                {% if thread_stats %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Farbe</th>
                                <th>Hersteller</th>
                                <th>Nummer</th>
                                <th>Name</th>
                                <th class="text-end">Verbrauch</th>
                                <th class="text-end">Zuletzt</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in thread_stats %}
                            <tr>
                                <td>
                                    <span class="color-badge"
                                          style="background-color: {{ stat.hex_color or '#cccccc' }};
                                                 width: 30px; height: 20px; display: inline-block;
                                                 border: 1px solid #ddd; border-radius: 3px;">
                                    </span>
                                </td>
                                <td>{{ stat.manufacturer }}</td>
                                <td>{{ stat.color_number }}</td>
                                <td>{{ stat.color_name_de or '-' }}</td>
                                <td class="text-end"><strong>{{ "%.1f"|format(stat.total_used) }}m</strong></td>
                                <td class="text-end">
                                    <small>{{ stat.last_used.strftime('%d.%m.') if stat.last_used else '-' }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">Keine Verbrauchsdaten im gewählten Zeitraum</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Benötigte Garne (Aktuell) -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list-check"></i> Benötigte Garne (Aktuelle Aufträge)</h5>
            </div>
            <div class="card-body">
                {% if required_threads %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Farbe</th>
                                <th>Hersteller</th>
                                <th>Nummer</th>
                                <th>Name</th>
                                <th>Auftrag</th>
                                <th class="text-end">Geschätzt</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in required_threads %}
                            <tr>
                                <td>
                                    <span class="color-badge"
                                          style="background-color: {{ item.thread.hex_color or '#cccccc' }};
                                                 width: 30px; height: 20px; display: inline-block;
                                                 border: 1px solid #ddd; border-radius: 3px;">
                                    </span>
                                </td>
                                <td>{{ item.thread.manufacturer }}</td>
                                <td>{{ item.thread.color_number }}</td>
                                <td>{{ item.thread.color_name_de or '-' }}</td>
                                <td>
                                    <a href="{{ url_for('order.show', order_id=item.order.id) }}">
                                        {{ item.order.id }}
                                    </a>
                                </td>
                                <td class="text-end">
                                    <small>{{ "%.1f"|format(item.estimated_usage) }}m</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">
                    {% if current_orders %}
                    Keine Garn-Informationen für aktuelle Aufträge verfügbar
                    {% else %}
                    Keine aktuellen Aufträge für diese Maschine
                    {% endif %}
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Aktuelle Aufträge -->
{% if current_orders %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Aktuelle Aufträge ({{ current_orders|length }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Auftrags-ID</th>
                                <th>Kunde</th>
                                <th>Status</th>
                                <th>Stichanzahl</th>
                                <th>Fällig am</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in current_orders %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('order.show', order_id=order.id) }}">
                                        {{ order.id }}
                                    </a>
                                </td>
                                <td>{{ order.customer.display_name if order.customer else 'Unbekannt' }}</td>
                                <td>
                                    {% if order.status == 'in_progress' %}
                                    <span class="badge bg-warning">In Arbeit</span>
                                    {% elif order.status == 'accepted' %}
                                    <span class="badge bg-info">Akzeptiert</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ order.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ "{:,}".format(order.stitch_count) if order.stitch_count else '-' }}</td>
                                <td>
                                    {% if order.due_date %}
                                    {{ order.due_date.strftime('%d.%m.%Y') }}
                                    {% if order.rush_order %}
                                    <span class="badge bg-danger">Eilauftrag</span>
                                    {% endif %}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('order.show', order_id=order.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: none;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #e9ecef;
    border-radius: 8px 8px 0 0 !important;
}

.table-hover tbody tr:hover {
    background-color: #f8f9fa;
}

.color-badge {
    vertical-align: middle;
}

.btn-group .btn.active {
    background-color: #0d6efd;
    color: white;
}
</style>
{% endblock %}
