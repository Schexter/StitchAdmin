{% extends "base.html" %}

{% block title %}Maschinenstundensätze - StitchAdmin{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="bi bi-gear-fill"></i> Maschinenstundensätze</h1>
            <div>
                <a href="{{ url_for('calculation_settings.index') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Zurück
                </a>
            </div>
        </div>
        <p class="text-muted mt-2">
            Konfiguriere die Stundensätze für deine Maschinen. Diese werden automatisch in die Kalkulation einbezogen.
        </p>
    </div>
</div>

<!-- Info-Banner -->
<div class="alert alert-info alert-dismissible fade show" role="alert">
    <i class="bi bi-lightbulb"></i> <strong>So funktioniert's:</strong>
    Der Maschinenstundensatz setzt sich zusammen aus: <strong>Abschreibung + Energiekosten + Wartung + Platzkosten</strong>.
    Du kannst auch einen Custom Rate manuell eingeben, wenn du eigene Berechnungen hast.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<!-- Formel-Erklärung -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-calculator"></i> Berechnungs-Formel</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3 text-center">
                <div class="formula-box">
                    <i class="bi bi-cash-coin fs-2 text-primary"></i>
                    <h6 class="mt-2">Abschreibung/h</h6>
                    <small class="text-muted">Anschaffung ÷ Nutzungsstunden</small>
                </div>
            </div>
            <div class="col-md-1 text-center pt-4">
                <h3 class="text-muted">+</h3>
            </div>
            <div class="col-md-3 text-center">
                <div class="formula-box">
                    <i class="bi bi-lightning-charge fs-2 text-warning"></i>
                    <h6 class="mt-2">Energiekosten/h</h6>
                    <small class="text-muted">Stromverbrauch × Preis</small>
                </div>
            </div>
            <div class="col-md-1 text-center pt-4">
                <h3 class="text-muted">+</h3>
            </div>
            <div class="col-md-3 text-center">
                <div class="formula-box">
                    <i class="bi bi-tools fs-2 text-success"></i>
                    <h6 class="mt-2">Wartung/h</h6>
                    <small class="text-muted">Wartungskosten verteilt</small>
                </div>
            </div>
        </div>
        <div class="text-center mt-3">
            <i class="bi bi-arrow-down fs-3 text-primary"></i>
            <h4 class="text-primary mt-2"><strong>= Maschinenstundensatz</strong></h4>
        </div>
    </div>
</div>

<!-- Maschinen -->
{% for machine in machines %}
<div class="card mb-4" id="machine-{{ machine.id }}">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-gear-fill text-primary"></i> {{ machine.name }}
                <span class="badge bg-secondary">{{ machine.type or 'Unbekannt' }}</span>
            </h5>
            <div>
                {% if machine.use_custom_rate %}
                <span class="badge bg-info">
                    <i class="bi bi-pencil"></i> Custom Rate aktiv
                </span>
                {% else %}
                <span class="badge bg-success">
                    <i class="bi bi-calculator"></i> Automatisch berechnet
                </span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('calculation_settings.update_machine_rate', machine_id=machine.id) }}">
            <!-- Aktuelle Werte -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="alert alert-light">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h6 class="text-muted">Maschinenstundensatz</h6>
                                <h3 class="text-primary">
                                    {{ "%.2f"|format(machine.get_hourly_rate() or 0) }} €
                                </h3>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-muted">Personalkostensatz</h6>
                                <h3 class="text-success">
                                    {{ "%.2f"|format(machine.get_labor_cost_per_hour() or 0) }} €
                                </h3>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-muted">Gesamt/Stunde</h6>
                                <h3 class="text-danger">
                                    {{ "%.2f"|format((machine.get_hourly_rate() or 0) + (machine.get_labor_cost_per_hour() or 0)) }} €
                                </h3>
                            </div>
                            <div class="col-md-3">
                                <h6 class="text-muted">Pro Minute</h6>
                                <h3 class="text-info">
                                    {{ "%.2f"|format(((machine.get_hourly_rate() or 0) + (machine.get_labor_cost_per_hour() or 0)) / 60) }} €
                                </h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Anschaffungs-Details -->
            <h6 class="mb-3"><i class="bi bi-cash-coin"></i> Anschaffung & Abschreibung</h6>
            <div class="row mb-4">
                <div class="col-md-4">
                    <label class="form-label">
                        Anschaffungspreis
                        <i class="bi bi-info-circle" title="Kaufpreis der Maschine"></i>
                    </label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="purchase_price"
                               value="{{ machine.purchase_price or 0 }}" step="0.01" min="0">
                        <span class="input-group-text">€</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">
                        Abschreibungsdauer
                        <i class="bi bi-info-circle" title="Über wie viele Jahre wird abgeschrieben?"></i>
                    </label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="depreciation_years"
                               value="{{ machine.depreciation_years or 10 }}" min="1">
                        <span class="input-group-text">Jahre</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">
                        Erwartete Nutzungsstunden
                        <i class="bi bi-info-circle" title="Gesamte Betriebsstunden über Lebenszeit"></i>
                    </label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="expected_lifetime_hours"
                               value="{{ machine.expected_lifetime_hours or 20000 }}" min="1">
                        <span class="input-group-text">h</span>
                    </div>
                </div>
            </div>

            <!-- Betriebskosten -->
            <h6 class="mb-3"><i class="bi bi-lightning-charge"></i> Betriebskosten pro Stunde</h6>
            <div class="row mb-4">
                <div class="col-md-4">
                    <label class="form-label">
                        Energiekosten
                        <i class="bi bi-info-circle" title="Stromkosten pro Betriebsstunde"></i>
                    </label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="energy_cost_per_hour"
                               value="{{ machine.energy_cost_per_hour or 2.0 }}" step="0.01" min="0">
                        <span class="input-group-text">€/h</span>
                    </div>
                    <small class="text-muted">Typisch: 1-5 €/h</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label">
                        Wartungskosten
                        <i class="bi bi-info-circle" title="Durchschnittliche Wartung pro Stunde"></i>
                    </label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="maintenance_cost_per_hour"
                               value="{{ machine.maintenance_cost_per_hour or 1.5 }}" step="0.01" min="0">
                        <span class="input-group-text">€/h</span>
                    </div>
                    <small class="text-muted">Typisch: 1-3 €/h</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label">
                        Platzkosten
                        <i class="bi bi-info-circle" title="Anteilige Miete/Platz pro Stunde"></i>
                    </label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="space_cost_per_hour"
                               value="{{ machine.space_cost_per_hour or 0.5 }}" step="0.01" min="0">
                        <span class="input-group-text">€/h</span>
                    </div>
                    <small class="text-muted">Typisch: 0.5-2 €/h</small>
                </div>
            </div>

            <!-- Custom Rate -->
            <div class="alert alert-warning">
                <h6><i class="bi bi-pencil-square"></i> Custom Rate (Optional)</h6>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="use_custom_rate" value="true"
                           id="useCustom_{{ machine.id }}" {{ 'checked' if machine.use_custom_rate else '' }}>
                    <label class="form-check-label" for="useCustom_{{ machine.id }}">
                        <strong>Custom Rate verwenden</strong> - Überschreibt die automatische Berechnung
                    </label>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Custom Maschinenstundensatz</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="custom_hourly_rate"
                                   value="{{ machine.custom_hourly_rate or 0 }}" step="0.01" min="0">
                            <span class="input-group-text">€/h</span>
                        </div>
                        <small class="text-muted">Nur aktiv, wenn Checkbox aktiviert ist</small>
                    </div>
                </div>
            </div>

            <!-- Personalkosten -->
            <h6 class="mb-3"><i class="bi bi-people"></i> Personalkosten</h6>
            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label">
                        Lohnkosten pro Stunde
                        <i class="bi bi-info-circle" title="Inkl. Lohnnebenkosten"></i>
                    </label>
                    <div class="input-group">
                        <input type="number" class="form-control" name="labor_cost_per_hour"
                               value="{{ machine.labor_cost_per_hour or 35.0 }}" step="0.01" min="0">
                        <span class="input-group-text">€/h</span>
                    </div>
                    <small class="text-muted">Bruttolohn + Sozialabgaben. Typisch: 30-50 €/h</small>
                </div>
            </div>

            <!-- Buttons -->
            <div class="d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Speichern & Neu berechnen
                </button>
            </div>
        </form>
    </div>
</div>
{% endfor %}

{% if not machines %}
<div class="alert alert-warning text-center py-5">
    <i class="bi bi-gear" style="font-size: 4rem;"></i>
    <h4 class="mt-3">Noch keine Maschinen vorhanden</h4>
    <p class="text-muted">Lege zuerst Maschinen an, um Stundensätze zu konfigurieren.</p>
    <a href="{{ url_for('machines.new') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Neue Maschine anlegen
    </a>
</div>
{% endif %}

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: none;
    border-radius: 8px;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #e9ecef;
    border-radius: 8px 8px 0 0 !important;
}

.formula-box {
    padding: 20px;
    border-radius: 8px;
    background-color: #f8f9fa;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.form-label {
    font-weight: 500;
}

.bi-info-circle {
    cursor: help;
    color: #0d6efd;
}
</style>
{% endblock %}
