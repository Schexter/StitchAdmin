{# 
    Aktivitäten-Widget (Include)
    Kann in Kunden- und Auftragsansicht eingebunden werden
    
    Erforderliche Variablen:
    - activities: Liste von ProductionBlock-Objekten
    - context: 'customer' oder 'order' (für Links)
    - show_customer: True/False (Kundenname anzeigen?)
    - show_order: True/False (Auftragsnummer anzeigen?)
    - limit: Anzahl anzeigen (optional, Default: 10)
    
    Erstellt von Hans Hahn - Alle Rechte vorbehalten
#}

<style>
.activities-widget {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    overflow: hidden;
}

.activities-widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}

.activities-widget-header h6 {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 600;
    color: #475569;
}

.activities-widget-header .badge {
    font-size: 0.7rem;
}

.activity-mini-item {
    display: flex;
    gap: 10px;
    padding: 10px 16px;
    border-bottom: 1px solid #f1f5f9;
    transition: background 0.2s;
    cursor: pointer;
}

.activity-mini-item:hover {
    background: #f8fafc;
}

.activity-mini-item:last-child {
    border-bottom: none;
}

.activity-mini-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.8rem;
    flex-shrink: 0;
}

.activity-mini-icon.call_in { background: #22c55e; }
.activity-mini-icon.call_out { background: #14b8a6; }
.activity-mini-icon.customer_visit { background: #0ea5e9; }
.activity-mini-icon.site_visit { background: #0284c7; }
.activity-mini-icon.email { background: #64748b; }
.activity-mini-icon.quote { background: #a855f7; }
.activity-mini-icon.complaint { background: #ef4444; }
.activity-mini-icon.meeting { background: #6366f1; }

.activity-mini-content {
    flex: 1;
    min-width: 0;
}

.activity-mini-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.activity-mini-title {
    font-size: 0.85rem;
    font-weight: 500;
    color: #1e293b;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.activity-mini-date {
    font-size: 0.7rem;
    color: #94a3b8;
    white-space: nowrap;
}

.activity-mini-summary {
    font-size: 0.75rem;
    color: #64748b;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 2px;
}

.activity-mini-meta {
    display: flex;
    gap: 8px;
    margin-top: 4px;
}

.activity-mini-badge {
    font-size: 0.65rem;
    padding: 1px 6px;
    border-radius: 3px;
    font-weight: 500;
}

.activity-mini-badge.customer { background: #dbeafe; color: #1e40af; }
.activity-mini-badge.order { background: #fef3c7; color: #92400e; }
.activity-mini-badge.outcome { background: #dcfce7; color: #166534; }
.activity-mini-badge.follow-up { background: #fee2e2; color: #991b1b; }

.activities-widget-footer {
    padding: 10px 16px;
    background: #f8fafc;
    border-top: 1px solid #e2e8f0;
    text-align: center;
}

.activities-widget-footer a {
    font-size: 0.8rem;
    color: #3b82f6;
    text-decoration: none;
}

.activities-widget-footer a:hover {
    text-decoration: underline;
}

.activities-empty {
    padding: 24px;
    text-align: center;
    color: #94a3b8;
}

.activities-empty i {
    font-size: 2rem;
    margin-bottom: 8px;
    opacity: 0.5;
}

.activities-empty p {
    margin: 0;
    font-size: 0.85rem;
}
</style>

<div class="activities-widget">
    <div class="activities-widget-header">
        <h6><i class="fas fa-history"></i> Aktivitäten</h6>
        <span class="badge bg-secondary">{{ activities|length if activities else 0 }}</span>
    </div>
    
    {% if activities %}
        {% for activity in activities[:limit|default(10)] %}
        <div class="activity-mini-item" onclick="showActivityDetail({{ activity.id }})">
            <div class="activity-mini-icon {{ activity.block_type }}">
                <i class="fas fa-{{ activity.display_icon }}"></i>
            </div>
            <div class="activity-mini-content">
                <div class="activity-mini-header">
                    <span class="activity-mini-title">{{ activity.title }}</span>
                    <span class="activity-mini-date">{{ activity.start_date.strftime('%d.%m.%y') }}</span>
                </div>
                {% if activity.summary %}
                <div class="activity-mini-summary">{{ activity.summary }}</div>
                {% endif %}
                <div class="activity-mini-meta">
                    {% if show_customer|default(true) and activity.customer %}
                    <span class="activity-mini-badge customer">
                        <i class="fas fa-building"></i> {{ activity.customer.display_name[:20] }}{% if activity.customer.display_name|length > 20 %}...{% endif %}
                    </span>
                    {% endif %}
                    {% if show_order|default(true) and activity.order_id %}
                    <span class="activity-mini-badge order">
                        <i class="fas fa-file"></i> {{ activity.order_id }}
                    </span>
                    {% endif %}
                    {% if activity.outcome %}
                    <span class="activity-mini-badge outcome">{{ activity.outcome_label }}</span>
                    {% endif %}
                    {% if activity.needs_follow_up %}
                    <span class="activity-mini-badge follow-up"><i class="fas fa-bell"></i> Fällig!</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="activities-empty">
            <i class="fas fa-phone-slash"></i>
            <p>Keine Aktivitäten vorhanden</p>
        </div>
    {% endif %}
    
    {% if context == 'customer' and customer_id %}
    <div class="activities-widget-footer">
        <a href="{{ url_for('crm.activities_search', customer_id=customer_id) }}">
            <i class="fas fa-search"></i> Alle Aktivitäten anzeigen
        </a>
        &nbsp;|&nbsp;
        <a href="{{ url_for('production.calendar_new') }}?customer={{ customer_id }}">
            <i class="fas fa-plus"></i> Neue Aktivität
        </a>
    </div>
    {% elif context == 'order' and order_id %}
    <div class="activities-widget-footer">
        <a href="{{ url_for('crm.activities_search', order_id=order_id) }}">
            <i class="fas fa-search"></i> Alle Aktivitäten
        </a>
        &nbsp;|&nbsp;
        <a href="{{ url_for('production.calendar_new') }}?order={{ order_id }}">
            <i class="fas fa-plus"></i> Neue Aktivität
        </a>
    </div>
    {% else %}
    <div class="activities-widget-footer">
        <a href="{{ url_for('crm.activities_search') }}">
            <i class="fas fa-arrow-right"></i> Alle Aktivitäten
        </a>
    </div>
    {% endif %}
</div>

<script>
// Aktivitäts-Detail (falls Modal noch nicht geladen)
if (typeof showActivityDetail === 'undefined') {
    function showActivityDetail(activityId) {
        // Fallback: Neue Seite öffnen
        window.location.href = `/crm/activities?highlight=${activityId}`;
    }
}
</script>
