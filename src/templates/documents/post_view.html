{% extends "base.html" %}

{% block title %}Post-Eintrag #{{ entry.entry_number or entry.id }} - StitchAdmin{% endblock %}

{% block content %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="row">
    <div class="col-md-12">
        <h1>
            <i class="bi bi-mailbox"></i> Post-Eintrag #{{ entry.entry_number or entry.id }}
        </h1>
        <div class="mb-3">
            <a href="{{ url_for('documents.post_list') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Zurück zur Übersicht
            </a>
            <a href="{{ url_for('documents.post_edit', id=entry.id) }}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Bearbeiten
            </a>
            {% if entry.status != 'completed' %}
            <button class="btn btn-success" onclick="markComplete()">
                <i class="bi bi-check-circle"></i> Als erledigt markieren
            </button>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <!-- Hauptinformationen -->
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Details</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th style="width: 200px;"><i class="bi bi-calendar3"></i> Datum:</th>
                        <td>{{ entry.entry_date.strftime('%d.%m.%Y %H:%M') if entry.entry_date else '-' }}</td>
                    </tr>
                    <tr>
                        <th><i class="bi bi-arrow-left-right"></i> Richtung:</th>
                        <td>
                            {% if entry.direction == 'inbound' %}
                                <span class="badge bg-success"><i class="bi bi-box-arrow-in-down"></i> Eingang</span>
                            {% else %}
                                <span class="badge bg-primary"><i class="bi bi-box-arrow-up"></i> Ausgang</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th><i class="bi bi-envelope"></i> Art:</th>
                        <td>
                            <span class="badge bg-secondary">
                                {% if entry.type == 'brief' %}Brief
                                {% elif entry.type == 'einschreiben' %}Einschreiben
                                {% elif entry.type == 'einschreiben_rueckschein' %}Einschreiben mit Rückschein
                                {% elif entry.type == 'paket' %}Paket
                                {% elif entry.type == 'fax' %}Fax
                                {% elif entry.type == 'email' %}E-Mail
                                {% else %}{{ entry.type }}
                                {% endif %}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th><i class="bi bi-chat-left-text"></i> Betreff:</th>
                        <td><strong>{{ entry.subject }}</strong></td>
                    </tr>
                    {% if entry.reference_number %}
                    <tr>
                        <th><i class="bi bi-hash"></i> Referenznummer:</th>
                        <td>{{ entry.reference_number }}</td>
                    </tr>
                    {% endif %}
                </table>

                <hr>

                <h6><i class="bi bi-people"></i> Absender & Empfänger</h6>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <strong>Von (Absender)</strong>
                            </div>
                            <div class="card-body">
                                <p class="mb-1"><strong>{{ entry.sender or '-' }}</strong></p>
                                {% if entry.sender_address %}
                                <p class="text-muted mb-0" style="white-space: pre-line;">{{ entry.sender_address }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <strong>An (Empfänger)</strong>
                            </div>
                            <div class="card-body">
                                <p class="mb-1"><strong>{{ entry.recipient or '-' }}</strong></p>
                                {% if entry.recipient_address %}
                                <p class="text-muted mb-0" style="white-space: pre-line;">{{ entry.recipient_address }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {% if entry.description or entry.notes %}
                <hr>
                <h6><i class="bi bi-text-paragraph"></i> Beschreibung / Notizen</h6>
                <p style="white-space: pre-line;">{{ entry.notes or entry.description }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Tracking Information -->
        {% if entry.tracking_number or entry.carrier %}
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-truck"></i> Tracking & Versand</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    {% if entry.tracking_number %}
                    <tr>
                        <th style="width: 200px;">Sendungsnummer:</th>
                        <td><code>{{ entry.tracking_number }}</code></td>
                    </tr>
                    {% endif %}
                    {% if entry.carrier %}
                    <tr>
                        <th>Versanddienstleister:</th>
                        <td>{{ entry.carrier }}</td>
                    </tr>
                    {% endif %}
                    {% if entry.shipping_cost %}
                    <tr>
                        <th>Versandkosten:</th>
                        <td>{{ "%.2f"|format(entry.shipping_cost) }} €</td>
                    </tr>
                    {% endif %}
                    {% if entry.delivery_status %}
                    <tr>
                        <th>Zustellstatus:</th>
                        <td>
                            <span class="badge
                                {% if entry.delivery_status == 'delivered' %}bg-success
                                {% elif entry.delivery_status == 'in_transit' %}bg-info
                                {% elif entry.delivery_status == 'returned' %}bg-danger
                                {% else %}bg-secondary{% endif %}">
                                {{ entry.delivery_status }}
                            </span>
                        </td>
                    </tr>
                    {% endif %}
                    {% if entry.delivery_date %}
                    <tr>
                        <th>Zugestellt am:</th>
                        <td>{{ entry.delivery_date.strftime('%d.%m.%Y %H:%M') }}</td>
                    </tr>
                    {% endif %}
                    {% if entry.signature_received %}
                    <tr>
                        <th>Unterschrift:</th>
                        <td>
                            <i class="bi bi-check-circle text-success"></i>
                            {{ entry.signature_name or 'Ja' }}
                        </td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Status & Priorität -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-circle-fill"></i> Status & Priorität</h6>
            </div>
            <div class="card-body">
                <p>
                    <strong>Status:</strong><br>
                    {% if entry.status == 'open' %}
                        <span class="badge bg-warning">Offen</span>
                    {% elif entry.status == 'in_progress' %}
                        <span class="badge bg-info">In Bearbeitung</span>
                    {% elif entry.status == 'completed' %}
                        <span class="badge bg-success">Erledigt</span>
                    {% elif entry.status == 'archived' %}
                        <span class="badge bg-secondary">Archiviert</span>
                    {% endif %}
                </p>
                <p>
                    <strong>Priorität:</strong><br>
                    {% if entry.priority == 'urgent' %}
                        <span class="badge bg-danger">Dringend</span>
                    {% elif entry.priority == 'high' %}
                        <span class="badge bg-warning">Hoch</span>
                    {% elif entry.priority == 'normal' %}
                        <span class="badge bg-secondary">Normal</span>
                    {% else %}
                        <span class="badge bg-light text-dark">Niedrig</span>
                    {% endif %}
                </p>
                {% if entry.due_date %}
                <p>
                    <strong>Fällig am:</strong><br>
                    {{ entry.due_date.strftime('%d.%m.%Y') }}
                </p>
                {% endif %}
                {% if entry.reminder_date %}
                <p>
                    <strong>Wiedervorlage:</strong><br>
                    {{ entry.reminder_date.strftime('%d.%m.%Y') }}
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Verknüpfungen -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-link-45deg"></i> Verknüpfungen</h6>
            </div>
            <div class="card-body">
                {% if entry.customer %}
                <p>
                    <strong>Kunde:</strong><br>
                    <a href="{{ url_for('customers.show', customer_id=entry.customer_id) }}">
                        {{ entry.customer.name }}
                    </a>
                </p>
                {% endif %}
                {% if entry.order_id %}
                <p>
                    <strong>Auftrag:</strong><br>
                    <a href="{{ url_for('orders.show', order_id=entry.order_id) }}">
                        Auftrag #{{ entry.order_id }}
                    </a>
                </p>
                {% endif %}
                {% if entry.document_id %}
                <p>
                    <strong>Dokument:</strong><br>
                    <a href="{{ url_for('documents.view', id=entry.document_id) }}">
                        Dokument anzeigen
                    </a>
                </p>
                {% endif %}
                {% if not entry.customer and not entry.order_id and not entry.document_id %}
                <p class="text-muted">Keine Verknüpfungen</p>
                {% endif %}
            </div>
        </div>

        <!-- Bearbeitung -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-person-badge"></i> Bearbeitung</h6>
            </div>
            <div class="card-body">
                {% if entry.handler %}
                <p>
                    <strong>Bearbeitet von:</strong><br>
                    {{ entry.handler.username }}
                </p>
                {% endif %}
                <p>
                    <strong>Erstellt:</strong><br>
                    <small>{{ entry.entry_date.strftime('%d.%m.%Y %H:%M') if entry.entry_date else '-' }}</small>
                </p>
            </div>
        </div>
    </div>
</div>

<script>
function markComplete() {
    if (confirm('Eintrag als erledigt markieren?')) {
        fetch(`/documents/post/{{ entry.id }}/complete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Fehler: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Markieren als erledigt');
        });
    }
}
</script>

{% endblock %}
