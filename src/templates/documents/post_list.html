{% extends "base.html" %}

{% block title %}Postbuch - StitchAdmin{% endblock %}

{% block content %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="row">
    <div class="col-md-12">
        <h1><i class="bi bi-mailbox"></i> Postbuch</h1>

        <div class="mb-3">
            <a href="{{ url_for('documents.post_new') }}" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Neue Post erfassen
            </a>
            <a href="{{ url_for('documents.dashboard') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Zurück zum Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Filter -->
<div class="card mb-3">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Suche</label>
                <input type="text" class="form-control" name="search" value="{{ search }}"
                       placeholder="Betreff, Absender oder Empfänger">
            </div>
            <div class="col-md-2">
                <label class="form-label">Richtung</label>
                <select class="form-control" name="direction">
                    <option value="">Alle</option>
                    <option value="inbound" {% if direction == 'inbound' %}selected{% endif %}>Eingang</option>
                    <option value="outbound" {% if direction == 'outbound' %}selected{% endif %}>Ausgang</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select class="form-control" name="status">
                    <option value="">Alle</option>
                    <option value="open" {% if status == 'open' %}selected{% endif %}>Offen</option>
                    <option value="in_progress" {% if status == 'in_progress' %}selected{% endif %}>In Bearbeitung</option>
                    <option value="completed" {% if status == 'completed' %}selected{% endif %}>Erledigt</option>
                    <option value="archived" {% if status == 'archived' %}selected{% endif %}>Archiviert</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Von Datum</label>
                <input type="date" class="form-control" name="date_from" value="{{ date_from }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Bis Datum</label>
                <input type="date" class="form-control" name="date_to" value="{{ date_to }}">
            </div>
            <div class="col-md-1">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-funnel"></i>
                    </button>
                    <a href="{{ url_for('documents.post_list') }}" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i>
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Statistik-Karten -->
<div class="row mb-3">
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body">
                <h6 class="text-muted">Gesamt</h6>
                <h3 class="mb-0">{{ entries|length }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body">
                <h6 class="text-muted">Offen</h6>
                <h3 class="mb-0">{{ entries|selectattr('status', 'equalto', 'open')|list|length }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body">
                <h6 class="text-muted">Erledigt</h6>
                <h3 class="mb-0">{{ entries|selectattr('status', 'equalto', 'completed')|list|length }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-danger">
            <div class="card-body">
                <h6 class="text-muted">Überfällig</h6>
                <h3 class="mb-0">0</h3>
            </div>
        </div>
    </div>
</div>

<!-- Post-Tabelle -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Nr.</th>
                        <th><i class="bi bi-arrow-left-right"></i></th>
                        <th>Art</th>
                        <th>Betreff</th>
                        <th>Von/An</th>
                        <th>Kunde</th>
                        <th>Status</th>
                        <th>Priorität</th>
                        <th>Fällig</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in entries %}
                    {% set today = None %}
                    <tr {% if entry.due_date and entry.status != 'completed' %}class="table-danger"{% endif %}>
                        <td>
                            <small>{{ entry.entry_date.strftime('%d.%m.%Y') if entry.entry_date else '-' }}</small><br>
                            <small class="text-muted">{{ entry.entry_date.strftime('%H:%M') if entry.entry_date else '' }}</small>
                        </td>
                        <td>
                            <small class="text-muted">{{ entry.entry_number or entry.id }}</small>
                        </td>
                        <td>
                            {% if entry.direction == 'inbound' %}
                                <i class="bi bi-box-arrow-in-down text-success" title="Eingang"></i>
                            {% else %}
                                <i class="bi bi-box-arrow-up text-primary" title="Ausgang"></i>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-secondary">
                                {% if entry.type == 'brief' %}Brief
                                {% elif entry.type == 'einschreiben' %}Einschreiben
                                {% elif entry.type == 'einschreiben_rueckschein' %}Einschreiben+
                                {% elif entry.type == 'paket' %}Paket
                                {% elif entry.type == 'fax' %}Fax
                                {% elif entry.type == 'email' %}E-Mail
                                {% else %}{{ entry.type }}
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <strong>{{ entry.subject }}</strong>
                            {% if entry.reference_number %}
                            <br><small class="text-muted">Ref: {{ entry.reference_number }}</small>
                            {% endif %}
                            {% if entry.tracking_number %}
                            <br><small class="text-info"><i class="bi bi-truck"></i> {{ entry.tracking_number }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.direction == 'inbound' %}
                                <small>{{ entry.sender or '-' }}</small>
                            {% else %}
                                <small>{{ entry.recipient or '-' }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.customer %}
                                <a href="{{ url_for('customers.show', customer_id=entry.customer_id) }}">
                                    {{ entry.customer.name }}
                                </a>
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.status == 'open' %}
                                <span class="badge bg-warning">Offen</span>
                            {% elif entry.status == 'in_progress' %}
                                <span class="badge bg-info">In Bearbeitung</span>
                            {% elif entry.status == 'completed' %}
                                <span class="badge bg-success">Erledigt</span>
                            {% elif entry.status == 'archived' %}
                                <span class="badge bg-secondary">Archiviert</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.priority == 'urgent' %}
                                <span class="badge bg-danger">Dringend</span>
                            {% elif entry.priority == 'high' %}
                                <span class="badge bg-warning">Hoch</span>
                            {% elif entry.priority == 'normal' %}
                                <span class="badge bg-secondary">Normal</span>
                            {% else %}
                                <span class="badge bg-light text-dark">Niedrig</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.due_date %}
                                <small>{{ entry.due_date.strftime('%d.%m.%Y') }}</small>
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('documents.post_view', id=entry.id) }}"
                               class="btn btn-sm btn-info" title="Details">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="{{ url_for('documents.post_edit', id=entry.id) }}"
                               class="btn btn-sm btn-primary" title="Bearbeiten">
                                <i class="bi bi-pencil"></i>
                            </a>
                            {% if entry.status != 'completed' %}
                            <button class="btn btn-sm btn-success"
                                    onclick="markComplete({{ entry.id }})"
                                    title="Als erledigt markieren">
                                <i class="bi bi-check-circle"></i>
                            </button>
                            {% endif %}
                            {% if entry.document_id %}
                            <a href="{{ url_for('documents.view', id=entry.document_id) }}"
                               class="btn btn-sm btn-secondary" title="Dokument anzeigen">
                                <i class="bi bi-file-earmark"></i>
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="11" class="text-center text-muted">
                            Keine Post-Einträge gefunden
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function markComplete(entryId) {
    if (confirm('Eintrag als erledigt markieren?')) {
        fetch(`/documents/post/${entryId}/complete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Fehler: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Markieren als erledigt');
        });
    }
}
</script>

{% endblock %}
