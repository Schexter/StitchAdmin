{% extends "base.html" %}

{% block title %}Neue Post erfassen - StitchAdmin{% endblock %}

{% block content %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="row">
    <div class="col-md-12">
        <h1><i class="bi bi-mailbox"></i> Neue Post erfassen</h1>
        <a href="{{ url_for('documents.post_list') }}" class="btn btn-secondary mb-3">
            <i class="bi bi-arrow-left"></i> Zurück zur Übersicht
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-body">
                <form method="POST" action="{{ url_for('documents.post_new') }}">

                    <!-- Basis-Daten -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-arrow-left-right"></i> Richtung *</label>
                            <select class="form-control" name="direction" required>
                                <option value="">Bitte wählen...</option>
                                <option value="inbound">Eingang (empfangen)</option>
                                <option value="outbound">Ausgang (versendet)</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-envelope"></i> Art *</label>
                            <select class="form-control" name="type" required>
                                <option value="">Bitte wählen...</option>
                                <option value="brief">Brief</option>
                                <option value="einschreiben">Einschreiben</option>
                                <option value="einschreiben_rueckschein">Einschreiben mit Rückschein</option>
                                <option value="paket">Paket</option>
                                <option value="fax">Fax</option>
                                <option value="email">E-Mail</option>
                            </select>
                        </div>
                    </div>

                    <!-- Betreff -->
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-chat-left-text"></i> Betreff *</label>
                        <input type="text" class="form-control" name="subject" required
                               placeholder="z.B. Rechnung Januar 2025">
                    </div>

                    <!-- Absender/Empfänger -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-person-fill"></i> Absender</label>
                            <input type="text" class="form-control" name="sender" id="sender"
                                   placeholder="Name des Absenders">
                            <textarea class="form-control mt-2" name="sender_address" id="sender_address" rows="2"
                                      placeholder="Adresse des Absenders (optional)"></textarea>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-person"></i> Empfänger</label>
                            <input type="text" class="form-control" name="recipient"
                                   placeholder="Name des Empfängers">
                            <textarea class="form-control mt-2" name="recipient_address" rows="2"
                                      placeholder="Adresse des Empfängers (optional)"></textarea>
                        </div>
                    </div>

                    <!-- Verknüpfungen -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-people"></i> Kunde</label>
                            <select class="form-control" name="customer_id">
                                <option value="">Kein Kunde zugeordnet</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}">
                                    {{ customer.company_name if customer.company_name else (customer.first_name + ' ' + customer.last_name) }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-hash"></i> Referenznummer</label>
                            <input type="text" class="form-control" name="reference_number"
                                   placeholder="Aktenzeichen, Kundennummer, etc.">
                        </div>
                    </div>

                    <!-- Tracking (für Versand) -->
                    <div class="card mb-3 border-info">
                        <div class="card-header bg-info text-white">
                            <i class="bi bi-truck"></i> Tracking & Versand (optional)
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Sendungsnummer</label>
                                    <input type="text" class="form-control" name="tracking_number"
                                           placeholder="z.B. 12345678901234">
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Versanddienstleister</label>
                                    <select class="form-control" name="carrier">
                                        <option value="">-</option>
                                        <option value="DHL">DHL</option>
                                        <option value="DPD">DPD</option>
                                        <option value="Hermes">Hermes</option>
                                        <option value="Deutsche Post">Deutsche Post</option>
                                        <option value="GLS">GLS</option>
                                        <option value="UPS">UPS</option>
                                        <option value="FedEx">FedEx</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Versandkosten</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="shipping_cost"
                                               step="0.01" min="0" placeholder="0.00">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status & Priorität -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label"><i class="bi bi-circle-fill"></i> Status</label>
                            <select class="form-control" name="status">
                                <option value="open" selected>Offen</option>
                                <option value="in_progress">In Bearbeitung</option>
                                <option value="completed">Erledigt</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label"><i class="bi bi-flag-fill"></i> Priorität</label>
                            <select class="form-control" name="priority">
                                <option value="low">Niedrig</option>
                                <option value="normal" selected>Normal</option>
                                <option value="high">Hoch</option>
                                <option value="urgent">Dringend</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label"><i class="bi bi-calendar-event"></i> Fälligkeitsdatum</label>
                            <input type="date" class="form-control" name="due_date">
                        </div>
                    </div>

                    <!-- Wiedervorlage -->
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-alarm"></i> Wiedervorlage am</label>
                        <input type="date" class="form-control" name="reminder_date">
                        <small class="form-text text-muted">Erinnert Sie an diesen Eintrag</small>
                    </div>

                    <!-- Beschreibung -->
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-text-paragraph"></i> Beschreibung / Notizen</label>
                        <textarea class="form-control" name="notes" rows="4"
                                  placeholder="Zusätzliche Informationen, Anmerkungen..."></textarea>
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('documents.post_list') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Abbrechen
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Post erfassen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Automatisch Absender/Empfänger anpassen basierend auf Richtung
document.querySelector('select[name="direction"]').addEventListener('change', function() {
    const senderLabel = document.querySelector('label[for="sender"]');
    const recipientLabel = document.querySelector('label[for="recipient"]');
    const senderInput = document.getElementById('sender');
    const senderAddressInput = document.getElementById('sender_address');

    if (this.value === 'inbound') {
        // Bei Eingang: Absender wichtiger
        senderLabel?.parentElement?.classList.add('border', 'border-success', 'p-2', 'rounded');
        recipientLabel?.parentElement?.classList.remove('border', 'border-primary', 'p-2', 'rounded');
    } else if (this.value === 'outbound') {
        // Bei Ausgang: Empfänger wichtiger
        recipientLabel?.parentElement?.classList.add('border', 'border-primary', 'p-2', 'rounded');
        senderLabel?.parentElement?.classList.remove('border', 'border-success', 'p-2', 'rounded');

        // Firmendaten als Absender eintragen
        {% if company %}
        if (!senderInput.value) {
            senderInput.value = '{{ company.display_name }}';
        }
        if (!senderAddressInput.value) {
            const address = [];
            {% if company.street and company.house_number %}
            address.push('{{ company.street }} {{ company.house_number }}');
            {% elif company.street %}
            address.push('{{ company.street }}');
            {% endif %}
            {% if company.postal_code and company.city %}
            address.push('{{ company.postal_code }} {{ company.city }}');
            {% elif company.city %}
            address.push('{{ company.city }}');
            {% endif %}
            senderAddressInput.value = address.join('\n');
        }
        {% endif %}
    }
});
</script>

{% endblock %}
