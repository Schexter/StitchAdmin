{% extends "base.html" %}
{% block title %}Auftrags-Wizard - Schritt 4: Kalkulation{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Wizard Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body py-3">
                    <div class="wizard-progress d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('wizard.step1') }}" class="wizard-step completed text-decoration-none">
                            <div class="step-circle"><i class="fas fa-check"></i></div>
                            <span class="step-label">Kunde</span>
                        </a>
                        <div class="wizard-line completed"></div>
                        <a href="{{ url_for('wizard.step2') }}" class="wizard-step completed text-decoration-none">
                            <div class="step-circle"><i class="fas fa-check"></i></div>
                            <span class="step-label">Textilien</span>
                        </a>
                        <div class="wizard-line completed"></div>
                        <a href="{{ url_for('wizard.step3') }}" class="wizard-step completed text-decoration-none">
                            <div class="step-circle"><i class="fas fa-check"></i></div>
                            <span class="step-label">Veredelung</span>
                        </a>
                        <div class="wizard-line completed"></div>
                        <div class="wizard-step active">
                            <div class="step-circle">4</div>
                            <span class="step-label">Kalkulation</span>
                        </div>
                        <div class="wizard-line"></div>
                        <div class="wizard-step">
                            <div class="step-circle">5</div>
                            <span class="step-label">Abschluss</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form method="POST" id="step4Form">
        <input type="hidden" name="positionen_json" id="positionenJson">
        
        <div class="row">
            <!-- Hauptbereich: Positionen -->
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Kalkulation</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px;">Pos.</th>
                                        <th>Bezeichnung</th>
                                        <th class="text-center" style="width: 80px;">Menge</th>
                                        <th class="text-end" style="width: 100px;">Einzelpreis</th>
                                        <th class="text-end" style="width: 120px;">Gesamt (netto)</th>
                                    </tr>
                                </thead>
                                <tbody id="positionenTabelle">
                                    {% for pos in kalkulation.positionen %}
                                    <tr class="position-row" data-typ="{{ pos.typ }}">
                                        <td class="text-muted">{{ pos.nr }}</td>
                                        <td>
                                            <strong>{{ pos.bezeichnung }}</strong>
                                            {% if pos.beschreibung %}
                                            <br><small class="text-muted">{{ pos.beschreibung }}</small>
                                            {% endif %}
                                            {% if pos.artikelnummer %}
                                            <br><small class="text-muted">Art.-Nr.: {{ pos.artikelnummer }}</small>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {{ pos.menge }} {{ pos.einheit }}
                                        </td>
                                        <td class="text-end">
                                            {{ "%.2f"|format(pos.einzelpreis) }} €
                                        </td>
                                        <td class="text-end fw-bold">
                                            {{ "%.2f"|format(pos.gesamt_netto) }} €
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Rabatt & Optionen -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-percent me-2"></i>Rabatt & Optionen</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <!-- Rabatt -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Rabatt</label>
                                <div class="input-group">
                                    <input type="number" class="form-control form-control-lg" 
                                           id="rabattProzent" name="rabatt_prozent"
                                           value="{{ kalkulation.rabatt_prozent|default(0) }}"
                                           min="0" max="50" step="0.5">
                                    <span class="input-group-text">%</span>
                                </div>
                                {% if kalkulation.mengen_rabatt_hinweis %}
                                <small class="text-success">
                                    <i class="fas fa-check-circle me-1"></i>{{ kalkulation.mengen_rabatt_hinweis }}
                                </small>
                                {% endif %}
                            </div>

                            <!-- Zahlungsbedingung -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Zahlungsbedingung</label>
                                <select class="form-select form-select-lg" name="zahlungsbedingung_id" id="zahlungsbedingung">
                                    <option value="">Standard (14 Tage)</option>
                                    {% for zb in zahlungsbedingungen %}
                                    <option value="{{ zb.id }}" 
                                            data-tage="{{ zb.zahlungsziel_tage }}"
                                            data-skonto="{{ zb.skonto_prozent }}"
                                            data-anzahlung="{{ zb.anzahlung_prozent if zb.anzahlung_erforderlich else 0 }}">
                                        {{ zb.bezeichnung }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Anzahlungs-Info -->
                        <div id="anzahlungInfo" class="alert alert-info mt-3 d-none">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Anzahlung erforderlich:</strong>
                            <span id="anzahlungText">50% bei Auftragserteilung</span>
                            <br>
                            <span class="fs-5">Anzahlungsbetrag: <strong id="anzahlungBetrag">0,00 €</strong></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rechte Spalte: Summen -->
            <div class="col-lg-4">
                <div class="card shadow-sm mb-4 sticky-top" style="top: 20px;">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Summen</h5>
                    </div>
                    <div class="card-body">
                        <!-- Zwischensumme -->
                        <div class="d-flex justify-content-between mb-2">
                            <span>Zwischensumme (netto):</span>
                            <span id="summeNetto">{{ "%.2f"|format(kalkulation.summe_netto) }} €</span>
                        </div>

                        <!-- Rabatt -->
                        <div class="d-flex justify-content-between mb-2 text-danger" id="rabattZeile" 
                             {% if kalkulation.rabatt_betrag <= 0 %}style="display:none !important;"{% endif %}>
                            <span>Rabatt (<span id="rabattProzentAnzeige">{{ kalkulation.rabatt_prozent }}</span>%):</span>
                            <span>- <span id="rabattBetrag">{{ "%.2f"|format(kalkulation.rabatt_betrag) }}</span> €</span>
                        </div>

                        <hr>

                        <!-- Netto nach Rabatt -->
                        <div class="d-flex justify-content-between mb-2">
                            <span>Netto:</span>
                            <span id="nettoNachRabatt">{{ "%.2f"|format(kalkulation.netto_nach_rabatt) }} €</span>
                        </div>

                        <!-- MwSt -->
                        <div class="d-flex justify-content-between mb-2 text-muted">
                            <span>MwSt. ({{ kalkulation.mwst_satz|int }}%):</span>
                            <span id="mwstBetrag">{{ "%.2f"|format(kalkulation.mwst_betrag) }} €</span>
                        </div>

                        <hr>

                        <!-- Gesamtsumme -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="fs-5 fw-bold">Gesamtsumme:</span>
                            <span class="fs-3 fw-bold text-success" id="summeBrutto">
                                {{ "%.2f"|format(kalkulation.summe_brutto) }} €
                            </span>
                        </div>

                        <!-- Stückpreis -->
                        <div class="alert alert-light py-2">
                            <div class="d-flex justify-content-between">
                                <span>Stückpreis (brutto):</span>
                                <strong id="stueckpreis">
                                    {% if kalkulation.gesamtmenge > 0 %}
                                    {{ "%.2f"|format(kalkulation.summe_brutto / kalkulation.gesamtmenge) }} €
                                    {% else %}
                                    0,00 €
                                    {% endif %}
                                </strong>
                            </div>
                            <small class="text-muted">bei {{ kalkulation.gesamtmenge }} Stück</small>
                        </div>

                        <!-- Skonto-Hinweis -->
                        <div id="skontoInfo" class="small text-muted d-none">
                            <i class="fas fa-info-circle me-1"></i>
                            Bei Zahlung innerhalb von <span id="skontoTage">7</span> Tagen:
                            <strong id="skontoBetrag">0,00 €</strong> Skonto
                        </div>
                    </div>
                </div>

                <!-- Kunde Info -->
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-user me-2"></i>Kunde</h6>
                    </div>
                    <div class="card-body">
                        <strong>{{ data.kunde.name }}</strong>
                        <br>
                        <small class="text-muted">{{ data.kunde.email }}</small>
                        {% if data.grunddaten.projektname %}
                        <hr class="my-2">
                        <small><strong>Projekt:</strong> {{ data.grunddaten.projektname }}</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body d-flex justify-content-between">
                        <a href="{{ url_for('wizard.step3') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Zurück
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            Weiter zur Zusammenfassung <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.wizard-progress { padding: 0 30px; }
.wizard-step { text-align: center; flex: 0 0 auto; }
.step-circle {
    width: 40px; height: 40px; border-radius: 50%;
    background: #e9ecef; color: #6c757d;
    display: flex; align-items: center; justify-content: center;
    font-weight: bold; margin: 0 auto 5px; transition: all 0.3s;
}
.wizard-step.active .step-circle { background: var(--bs-primary); color: white; }
.wizard-step.completed .step-circle { background: var(--bs-success); color: white; }
.step-label { font-size: 0.85rem; color: #6c757d; }
.wizard-step.active .step-label { color: var(--bs-primary); font-weight: bold; }
.wizard-line { flex: 1; height: 3px; background: #e9ecef; margin: 0 10px; margin-bottom: 20px; }
.wizard-line.completed { background: var(--bs-success); }

.position-row[data-typ="textil"] { background: rgba(25, 135, 84, 0.05); }
.position-row[data-typ^="veredelung"] { background: rgba(13, 110, 253, 0.05); }
.position-row[data-typ="einrichtung"] { background: rgba(255, 193, 7, 0.05); }
</style>

<script>
const kalkulationsDaten = {{ kalkulation|tojson|safe }};

document.addEventListener('DOMContentLoaded', function() {
    // Rabatt-Änderung
    document.getElementById('rabattProzent').addEventListener('input', function() {
        berechneNeu();
    });
    
    // Zahlungsbedingung-Änderung
    document.getElementById('zahlungsbedingung').addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        const skonto = parseFloat(option.dataset.skonto) || 0;
        const anzahlung = parseFloat(option.dataset.anzahlung) || 0;
        
        // Skonto-Info
        const skontoInfo = document.getElementById('skontoInfo');
        if (skonto > 0) {
            skontoInfo.classList.remove('d-none');
            document.getElementById('skontoTage').textContent = option.dataset.tage;
            const brutto = parseFloat(document.getElementById('summeBrutto').textContent);
            document.getElementById('skontoBetrag').textContent = (brutto * skonto / 100).toFixed(2) + ' €';
        } else {
            skontoInfo.classList.add('d-none');
        }
        
        // Anzahlung-Info
        const anzahlungInfo = document.getElementById('anzahlungInfo');
        if (anzahlung > 0) {
            anzahlungInfo.classList.remove('d-none');
            document.getElementById('anzahlungText').textContent = anzahlung + '% bei Auftragserteilung';
            const brutto = parseFloat(document.getElementById('summeBrutto').textContent.replace(' €', '').replace(',', '.'));
            document.getElementById('anzahlungBetrag').textContent = (brutto * anzahlung / 100).toFixed(2).replace('.', ',') + ' €';
        } else {
            anzahlungInfo.classList.add('d-none');
        }
    });
});

function berechneNeu() {
    const rabattProzent = parseFloat(document.getElementById('rabattProzent').value) || 0;
    const summeNetto = kalkulationsDaten.summe_netto;
    
    const rabattBetrag = summeNetto * rabattProzent / 100;
    const nettoNachRabatt = summeNetto - rabattBetrag;
    const mwstBetrag = nettoNachRabatt * 0.19;
    const brutto = nettoNachRabatt + mwstBetrag;
    
    // Anzeige aktualisieren
    document.getElementById('rabattProzentAnzeige').textContent = rabattProzent;
    document.getElementById('rabattBetrag').textContent = rabattBetrag.toFixed(2);
    document.getElementById('rabattZeile').style.display = rabattBetrag > 0 ? 'flex' : 'none';
    
    document.getElementById('nettoNachRabatt').textContent = nettoNachRabatt.toFixed(2) + ' €';
    document.getElementById('mwstBetrag').textContent = mwstBetrag.toFixed(2) + ' €';
    document.getElementById('summeBrutto').textContent = brutto.toFixed(2) + ' €';
    
    // Stückpreis
    if (kalkulationsDaten.gesamtmenge > 0) {
        document.getElementById('stueckpreis').textContent = (brutto / kalkulationsDaten.gesamtmenge).toFixed(2) + ' €';
    }
}
</script>
{% endblock %}
