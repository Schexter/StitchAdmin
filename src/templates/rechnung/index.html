{% extends "base.html" %}

{% block title %}Rechnungen - StitchAdmin{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1><i class="bi bi-file-text"></i> Rechnungsverwaltung</h1>

    <!-- Tabs für Eingang/Ausgang -->
    <ul class="nav nav-tabs mb-4" id="rechnungsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if tab == 'ausgang' %}active{% endif %}"
               href="{{ url_for('rechnung.rechnungs_index', tab='ausgang') }}">
                <i class="bi bi-box-arrow-up-right"></i> Ausgangsrechnungen
                <span class="badge bg-primary ms-1">{{ ausgang_total_count|default(0) }}</span>
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if tab == 'eingang' %}active{% endif %}"
               href="{{ url_for('rechnung.rechnungs_index', tab='eingang') }}">
                <i class="bi bi-box-arrow-in-left"></i> Eingangsrechnungen
                <span class="badge bg-secondary ms-1">{{ eingang_total_count|default(0) }}</span>
            </a>
        </li>
    </ul>

    {% if tab == 'ausgang' %}
    <!-- AUSGANGSRECHNUNGEN -->

    <!-- Statistik-Karten -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-warning h-100">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning"><i class="bi bi-clock"></i> Offen</h5>
                    <h2 class="text-warning">{{ ausgang_offen_count|default(0) }}</h2>
                    <p class="text-muted mb-0">{{ "%.2f"|format(ausgang_offen_total|default(0)) }} €</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-danger h-100">
                <div class="card-body text-center">
                    <h5 class="card-title text-danger"><i class="bi bi-exclamation-triangle"></i> Überfällig</h5>
                    <h2 class="text-danger">{{ ausgang_ueberfaellig_count|default(0) }}</h2>
                    <p class="text-muted mb-0">{{ "%.2f"|format(ausgang_ueberfaellig_total|default(0)) }} €</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success h-100">
                <div class="card-body text-center">
                    <h5 class="card-title text-success"><i class="bi bi-check-circle"></i> Bezahlt (Monat)</h5>
                    <h2 class="text-success">{{ ausgang_bezahlt_count|default(0) }}</h2>
                    <p class="text-muted mb-0">{{ "%.2f"|format(ausgang_bezahlt_total|default(0)) }} €</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-primary h-100">
                <div class="card-body text-center">
                    <h5 class="card-title text-primary"><i class="bi bi-graph-up"></i> Gesamt</h5>
                    <h2 class="text-primary">{{ ausgang_total_count|default(0) }}</h2>
                    <p class="text-muted mb-0">{{ "%.2f"|format(year_total_amount|default(0)) }} €</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Aktionsbuttons -->
    <div class="row mb-4">
        <div class="col-md-4">
            <a href="{{ url_for('rechnung.neue_rechnung') }}" class="btn btn-success btn-lg w-100">
                <i class="bi bi-plus-circle"></i> Neue Rechnung erstellen
            </a>
        </div>
        <div class="col-md-4">
            <a href="{{ url_for('rechnung.neue_rechnung_aus_auftrag') }}" class="btn btn-primary btn-lg w-100">
                <i class="bi bi-cart-check"></i> Aus Auftrag erstellen
            </a>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-secondary btn-lg w-100" data-bs-toggle="modal" data-bs-target="#exportModal">
                <i class="bi bi-download"></i> Export
            </button>
        </div>
        <div class="col-md-2">
            <a href="{{ url_for('rechnung.rechnungs_archiv') }}" class="btn btn-outline-info btn-lg w-100">
                <i class="bi bi-archive"></i> Archiv
            </a>
        </div>
    </div>

    <!-- Rechnungsliste Ausgang -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> Ausgangsrechnungen (an Kunden)</h5>
        </div>
        <div class="card-body">
            {% if ausgangsrechnungen %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Rechnungs-Nr.</th>
                            <th>Datum</th>
                            <th>Kunde</th>
                            <th class="text-end">Netto</th>
                            <th class="text-end">Brutto</th>
                            <th>Fälligkeit</th>
                            <th>Status</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rechnung in ausgangsrechnungen %}
                        <tr>
                            <td>
                                <a href="{{ url_for('rechnung.rechnung_detail', rechnung_id=rechnung.id) }}">
                                    <strong>{{ rechnung.rechnungsnummer }}</strong>
                                </a>
                            </td>
                            <td>{{ rechnung.rechnungsdatum.strftime('%d.%m.%Y') if rechnung.rechnungsdatum else '-' }}</td>
                            <td>
                                {% if rechnung.kunde %}
                                    {{ rechnung.kunde_name or rechnung.kunde.display_name }}
                                {% else %}
                                    {{ rechnung.kunde_name or '-' }}
                                {% endif %}
                            </td>
                            <td class="text-end">{{ "%.2f"|format(rechnung.netto_gesamt|float) }} €</td>
                            <td class="text-end"><strong>{{ "%.2f"|format(rechnung.brutto_gesamt|float) }} €</strong></td>
                            <td>
                                {% if rechnung.faelligkeitsdatum %}
                                    {{ rechnung.faelligkeitsdatum.strftime('%d.%m.%Y') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if rechnung.status.value == 'BEZAHLT' %}
                                    <span class="badge bg-success">Bezahlt</span>
                                {% elif rechnung.status.value == 'OFFEN' %}
                                    <span class="badge bg-warning">Offen</span>
                                {% elif rechnung.status.value == 'ENTWURF' %}
                                    <span class="badge bg-secondary">Entwurf</span>
                                {% elif rechnung.status.value == 'UEBERFAELLIG' %}
                                    <span class="badge bg-danger">Überfällig</span>
                                {% elif rechnung.status.value == 'STORNIERT' %}
                                    <span class="badge bg-dark">Storniert</span>
                                {% else %}
                                    <span class="badge bg-info">{{ rechnung.status.value }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('rechnung.rechnung_detail', rechnung_id=rechnung.id) }}"
                                       class="btn btn-outline-primary" title="Anzeigen">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{{ url_for('rechnung.rechnung_pdf', rechnung_id=rechnung.id) }}"
                                       class="btn btn-outline-secondary" title="PDF" target="_blank">
                                        <i class="bi bi-file-pdf"></i>
                                    </a>
                                    {% if rechnung.status.value in ['ENTWURF', 'OFFEN'] %}
                                    <button class="btn btn-outline-success" title="Als bezahlt markieren"
                                            onclick="markAsPaid({{ rechnung.id }})">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                <h4 class="text-muted mt-3">Keine Ausgangsrechnungen vorhanden</h4>
                <p class="text-muted">Erstellen Sie Ihre erste Rechnung</p>
                <a href="{{ url_for('rechnung.neue_rechnung') }}" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Neue Rechnung erstellen
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    {% else %}
    <!-- EINGANGSRECHNUNGEN -->

    <!-- Statistik-Karten Eingang -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-warning h-100">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning"><i class="bi bi-clock"></i> Zu bezahlen</h5>
                    <h2 class="text-warning">{{ eingang_offen_count|default(0) }}</h2>
                    <p class="text-muted mb-0">{{ "%.2f"|format(eingang_offen_total|default(0)) }} €</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-primary h-100">
                <div class="card-body text-center">
                    <h5 class="card-title text-primary"><i class="bi bi-receipt"></i> Gesamt</h5>
                    <h2 class="text-primary">{{ eingang_total_count|default(0) }}</h2>
                    <p class="text-muted mb-0">Eingangsrechnungen</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <a href="{{ url_for('rechnung.neue_eingangsrechnung') }}" class="btn btn-success btn-lg w-100 h-100 d-flex align-items-center justify-content-center">
                <i class="bi bi-plus-circle me-2"></i> Eingangsrechnung erfassen
            </a>
        </div>
    </div>

    <!-- Rechnungsliste Eingang -->
    <div class="card">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> Eingangsrechnungen (von Lieferanten)</h5>
        </div>
        <div class="card-body">
            {% if eingangsrechnungen %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Rechnungs-Nr.</th>
                            <th>Datum</th>
                            <th>Lieferant</th>
                            <th class="text-end">Netto</th>
                            <th class="text-end">Brutto</th>
                            <th>Fälligkeit</th>
                            <th>Status</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rechnung in eingangsrechnungen %}
                        <tr>
                            <td>
                                <a href="{{ url_for('rechnung.rechnung_detail', rechnung_id=rechnung.id) }}">
                                    <strong>{{ rechnung.rechnungsnummer }}</strong>
                                </a>
                            </td>
                            <td>{{ rechnung.rechnungsdatum.strftime('%d.%m.%Y') if rechnung.rechnungsdatum else '-' }}</td>
                            <td>{{ rechnung.lieferant_name or '-' }}</td>
                            <td class="text-end">{{ "%.2f"|format(rechnung.netto_gesamt|float) }} €</td>
                            <td class="text-end"><strong>{{ "%.2f"|format(rechnung.brutto_gesamt|float) }} €</strong></td>
                            <td>
                                {% if rechnung.faelligkeitsdatum %}
                                    {{ rechnung.faelligkeitsdatum.strftime('%d.%m.%Y') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if rechnung.status.value == 'BEZAHLT' %}
                                    <span class="badge bg-success">Bezahlt</span>
                                {% elif rechnung.status.value == 'OFFEN' %}
                                    <span class="badge bg-warning">Offen</span>
                                {% else %}
                                    <span class="badge bg-info">{{ rechnung.status.value }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('rechnung.rechnung_detail', rechnung_id=rechnung.id) }}"
                                       class="btn btn-outline-primary" title="Anzeigen">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    {% if rechnung.status.value == 'OFFEN' %}
                                    <button class="btn btn-outline-success" title="Als bezahlt markieren"
                                            onclick="markAsPaid({{ rechnung.id }})">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                <h4 class="text-muted mt-3">Keine Eingangsrechnungen vorhanden</h4>
                <p class="text-muted">Erfassen Sie Rechnungen von Ihren Lieferanten</p>
                <a href="{{ url_for('rechnung.neue_eingangsrechnung') }}" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Eingangsrechnung erfassen
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
function markAsPaid(rechnungId) {
    if (confirm('Rechnung als bezahlt markieren?')) {
        fetch(`/rechnung/api/${rechnungId}/bezahlt`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Fehler: ' + data.error);
            }
        });
    }
}
</script>
{% endblock %}
