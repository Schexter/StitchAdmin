{% extends "base.html" %}

{% block title %}Versendung {{ shipment.id }} - StitchAdmin{% endblock %}

{% block content %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="row">
    <div class="col-md-12">
        <h1><i class="bi bi-truck"></i> Versendung {{ shipment.id }}</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('shipping.index') }}">Versand</a></li>
                <li class="breadcrumb-item active">{{ shipment.id }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <!-- Versendungsstatus -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> Status & Tracking</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6>Aktueller Status:</h6>
                        {% if shipment.status == 'prepared' %}
                            <span class="badge bg-warning fs-6">Vorbereitet</span>
                        {% elif shipment.status == 'shipped' %}
                            <span class="badge bg-primary fs-6">Versendet</span>
                        {% elif shipment.status == 'delivered' %}
                            <span class="badge bg-success fs-6">Zugestellt</span>
                        {% elif shipment.status == 'ready_for_pickup' %}
                            <span class="badge bg-info fs-6">Abholbereit</span>
                        {% elif shipment.status == 'returned' %}
                            <span class="badge bg-danger fs-6">Retour</span>
                        {% endif %}
                        
                        {% if shipment.tracking_number %}
                            <h6 class="mt-3">Tracking-Nummer:</h6>
                            <p class="font-monospace">{{ shipment.tracking_number }}</p>
                            {% if tracking_url %}
                                <a href="{{ tracking_url }}" target="_blank" class="btn btn-info">
                                    <i class="bi bi-search"></i> Online verfolgen
                                </a>
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6 text-end">
                        {% if shipment.status == 'prepared' and shipment.carrier != 'pickup' %}
                            <form method="POST" action="{{ url_for('shipping.mark_shipped', shipment_id=shipment.id) }}" 
                                  class="mb-2">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-truck"></i> Als versendet markieren
                                </button>
                            </form>
                        {% endif %}
                        
                        {% if shipment.status == 'shipped' or shipment.status == 'ready_for_pickup' %}
                            <form method="POST" action="{{ url_for('shipping.mark_delivered', shipment_id=shipment.id) }}">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-check-circle"></i> Als zugestellt markieren
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Status-Timeline -->
                <div class="mt-4">
                    <h6>Versandverlauf:</h6>
                    <div class="timeline">
                        <div class="timeline-item">
                            <i class="bi bi-circle-fill text-success"></i>
                            <strong>Erstellt</strong> - {{ shipment.created_at[:16].replace('T', ' ') }}
                            <br><small class="text-muted">von {{ shipment.created_by }}</small>
                        </div>
                        
                        {% if shipment.shipped_date %}
                        <div class="timeline-item">
                            <i class="bi bi-circle-fill text-primary"></i>
                            <strong>
                                {% if shipment.carrier == 'pickup' %}Abholbereit{% else %}Versendet{% endif %}
                            </strong> - {{ shipment.shipped_date[:16].replace('T', ' ') }}
                            {% if shipment.shipped_by %}
                                <br><small class="text-muted">von {{ shipment.shipped_by }}</small>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        {% if shipment.delivered_date %}
                        <div class="timeline-item">
                            <i class="bi bi-circle-fill text-success"></i>
                            <strong>Zugestellt</strong> - {{ shipment.delivered_date[:16].replace('T', ' ') }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Auftragsinformationen -->
        <div class="card">
            <div class="card-header">
                <h6><i class="bi bi-clipboard-data"></i> Auftragsinformationen</h6>
            </div>
            <div class="card-body">
                {% if order %}
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Auftrag:</strong></td>
                                <td>
                                    <a href="{{ url_for('orders.show', order_id=order.id) }}">
                                        {{ order.id }}
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Typ:</strong></td>
                                <td>
                                    {% if order.order_type == 'embroidery' %}
                                        <span class="badge bg-primary">Bestickung</span>
                                    {% elif order.order_type == 'printing' %}
                                        <span class="badge bg-success">Textildruck</span>
                                    {% elif order.order_type == 'combined' %}
                                        <span class="badge bg-info">Kombiniert</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Artikel:</strong></td>
                                <td>{{ order.quantity }}x {{ order.textile_type|title or 'Textil' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Design:</strong></td>
                                <td>{{ order.design_description or order.description }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Auftragswert:</strong></td>
                                <td>{{ "%.2f"|format(order.price) }} €</td>
                            </tr>
                            <tr>
                                <td><strong>Versandkosten:</strong></td>
                                <td>
                                    {% if shipment.shipping_cost == 0 %}
                                        <span class="text-success">Kostenlos</span>
                                    {% else %}
                                        {{ "%.2f"|format(shipment.shipping_cost) }} €
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Gesamtwert:</strong></td>
                                <td><strong>{{ "%.2f"|format(order.price + shipment.shipping_cost) }} €</strong></td>
                            </tr>
                            <tr>
                                <td><strong>Priorität:</strong></td>
                                <td>
                                    {% if order.priority == 'urgent' %}
                                        <span class="badge bg-danger">Dringend</span>
                                    {% elif order.priority == 'high' %}
                                        <span class="badge bg-warning">Hoch</span>
                                    {% else %}
                                        {{ order.priority|title }}
                                    {% endif %}
                                    {% if order.rush_order %}
                                        <span class="badge bg-danger">EXPRESS</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Versanddetails -->
        <div class="card mb-4">
            <div class="card-header">
                <h6><i class="bi bi-truck"></i> Versanddetails</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td><strong>Versandart:</strong></td>
                        <td>{{ shipment.carrier_name }}</td>
                    </tr>
                    {% if shipment.package_weight %}
                    <tr>
                        <td><strong>Gewicht:</strong></td>
                        <td>{{ shipment.package_weight }} kg</td>
                    </tr>
                    {% endif %}
                    {% if shipment.package_dimensions %}
                    <tr>
                        <td><strong>Abmessungen:</strong></td>
                        <td>{{ shipment.package_dimensions }} cm</td>
                    </tr>
                    {% endif %}
                    {% if shipment.special_instructions %}
                    <tr>
                        <td><strong>Anweisungen:</strong></td>
                        <td><small>{{ shipment.special_instructions }}</small></td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>

        <!-- Lieferadresse -->
        <div class="card mb-4">
            <div class="card-header">
                <h6><i class="bi bi-geo-alt"></i> Lieferadresse</h6>
            </div>
            <div class="card-body">
                <address>
                    <strong>{{ shipment.shipping_address.name|safe }}</strong><br>
                    {{ shipment.shipping_address.street }} {{ shipment.shipping_address.house_number }}<br>
                    {{ shipment.shipping_address.postal_code }} {{ shipment.shipping_address.city }}<br>
                    {{ shipment.shipping_address.country }}
                </address>
            </div>
        </div>

        <!-- Aktionen -->
        <div class="card">
            <div class="card-header">
                <h6><i class="bi bi-tools"></i> Aktionen</h6>
            </div>
            <div class="card-body">
                <a href="{{ url_for('shipping.generate_shipping_label', shipment_id=shipment.id) }}" 
                   class="btn btn-primary w-100 mb-2" target="_blank">
                    <i class="bi bi-printer"></i> Versandetikett drucken
                </a>
                
                {% if order %}
                <a href="{{ url_for('shipping.generate_packing_list', order_id=order.id) }}" 
                   class="btn btn-info w-100 mb-2" target="_blank">
                    <i class="bi bi-list-check"></i> Packliste drucken
                </a>
                {% endif %}
                
                {% if shipment.tracking_number and tracking_url %}
                <a href="{{ tracking_url }}" class="btn btn-secondary w-100" target="_blank">
                    <i class="bi bi-search"></i> Online verfolgen
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="mt-3">
    <a href="{{ url_for('shipping.index') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Zurück zur Versandübersicht
    </a>
</div>

<style>
.timeline-item {
    margin-bottom: 1rem;
    padding-left: 2rem;
    position: relative;
}

.timeline-item i {
    position: absolute;
    left: 0;
    top: 0.2rem;
}
</style>
{% endblock %}