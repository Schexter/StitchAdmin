{% extends "base.html" %}

{% block title %}Versand vorbereiten - StitchAdmin{% endblock %}

{% block content %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="row">
    <div class="col-md-12">
        <h1><i class="bi bi-truck"></i> Versand vorbereiten</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('shipping.index') }}">Versand</a></li>
                <li class="breadcrumb-item active">Versand vorbereiten</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-box"></i> Auftrag {{ order.id }}</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('shipping.create_shipment', order_id=order.id) }}">
                    <!-- Versandart wählen -->
                    <div class="mb-4">
                        <h6><i class="bi bi-truck"></i> Versandart wählen</h6>
                        {% for carrier_id, carrier in settings.carriers.items() %}
                            {% if carrier.enabled %}
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="carrier" 
                                               id="carrier_{{ carrier_id }}" value="{{ carrier_id }}" 
                                               {% if carrier_id == 'pickup' %}checked{% endif %}>
                                        <label class="form-check-label w-100" for="carrier_{{ carrier_id }}">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>{{ carrier.name }}</strong>
                                                    {% if carrier_id == 'pickup' %}
                                                        <br><small class="text-muted">Kunde holt selbst ab</small>
                                                    {% else %}
                                                        <br><small class="text-muted">Lieferung an Kundenadresse</small>
                                                    {% endif %}
                                                </div>
                                                <div class="text-end">
                                                    {% set cost = shipping_costs.get(carrier_id, 0) %}
                                                    {% if cost == 0 %}
                                                        <span class="badge bg-success">Kostenlos</span>
                                                    {% else %}
                                                        <span class="badge bg-primary">{{ "%.2f"|format(cost) }} €</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <!-- Paket-Details -->
                    <div class="mb-4">
                        <h6><i class="bi bi-box-seam"></i> Paket-Details</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label" for="package_weight">Gewicht (kg)</label>
                                    <input type="number" class="form-control" id="package_weight" 
                                           name="package_weight" value="{{ order_weight or settings.default_package_weight }}" 
                                           step="0.1" min="0.1" required>
                                    {% if order_weight %}
                                    <small class="text-muted">Berechnet: {{ "%.3f"|format(order_weight) }} kg ({{ order.quantity }}x {{ order.textile_type or 'Artikel' }})</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label" for="package_dimensions">Abmessungen (L×B×H cm)</label>
                                    <input type="text" class="form-control" id="package_dimensions" 
                                           name="package_dimensions" placeholder="z.B. 30×20×5">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Besondere Anweisungen -->
                    <div class="mb-4">
                        <label class="form-label" for="special_instructions">Besondere Anweisungen</label>
                        <textarea class="form-control" id="special_instructions" name="special_instructions" 
                                  rows="3" placeholder="z.B. Vorsicht zerbrechlich, Vor Nässe schützen..."></textarea>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('shipping.index') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Zurück
                        </a>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-lg"></i> Versendung erstellen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Auftragsdetails -->
        <div class="card mb-4">
            <div class="card-header">
                <h6><i class="bi bi-info-circle"></i> Auftragsdetails</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td><strong>Auftrag:</strong></td>
                        <td>{{ order.id }}</td>
                    </tr>
                    <tr>
                        <td><strong>Kunde:</strong></td>
                        <td>{{ order.customer_name }}</td>
                    </tr>
                    <tr>
                        <td><strong>Artikel:</strong></td>
                        <td>{{ order.quantity }}x {{ order.textile_type|title or 'Textil' }}</td>
                    </tr>
                    <tr>
                        <td><strong>Design:</strong></td>
                        <td>{{ order.design_description or order.description }}</td>
                    </tr>
                    <tr>
                        <td><strong>Wert:</strong></td>
                        <td><strong>{{ "%.2f"|format(order.price) }} €</strong></td>
                    </tr>
                    {% if order.special_instructions %}
                    <tr>
                        <td><strong>Hinweise:</strong></td>
                        <td><small>{{ order.special_instructions }}</small></td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>

        <!-- Lieferadresse -->
        <div class="card">
            <div class="card-header">
                <h6><i class="bi bi-geo-alt"></i> Lieferadresse</h6>
            </div>
            <div class="card-body">
                {% if customer %}
                    <address>
                        <strong>{{ customer.first_name }} {{ customer.last_name }}</strong><br>
                        {{ customer.street }} {{ customer.house_number }}<br>
                        {{ customer.postal_code }} {{ customer.city }}<br>
                        {{ customer.country or 'Deutschland' }}
                        {% if customer.phone %}
                            <br><small>Tel: {{ customer.phone }}</small>
                        {% endif %}
                        {% if customer.email %}
                            <br><small>E-Mail: {{ customer.email }}</small>
                        {% endif %}
                    </address>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> Kundenadresse nicht vollständig!
                        <br><a href="{{ url_for('customers.edit', customer_id=order.customer_id) }}" 
                               class="btn btn-sm btn-warning mt-2">Adresse ergänzen</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}