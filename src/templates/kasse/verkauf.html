{% extends "base.html" %}

{% block title %}Kassenverkauf - StitchAdmin{% endblock %}

{% block content %}
<!-- Artikel-Such-Modal -->
{% include 'includes/article_search_modal.html' %}
<div class="container-fluid">
    <div class="row">
        <!-- Artikel-Suche und Warenkorb (unverändert) -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4><i class="bi bi-cart"></i> Verkauf</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <div class="input-group">
                                <input type="text" class="form-control form-control-lg" id="articleSearch"
                                       placeholder="Artikel- oder Auftragssuche..." autofocus>
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <span id="searchTypeLabel">Artikel</span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="setSearchType('artikel')">
                                        <i class="bi bi-box"></i> Artikel</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setSearchType('auftrag')">
                                        <i class="bi bi-receipt"></i> Auftrag</a></li>
                                </ul>
                            </div>
                            <div id="searchResults" class="list-group mt-1" style="display: none; max-height: 300px; overflow-y: auto; position: absolute; z-index: 1000; width: 100%;">
                                <!-- Suchergebnisse werden hier dynamisch eingefügt -->
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-info btn-lg w-100" id="listButton" onclick="showList()">
                                <i class="bi bi-list"></i> <span id="listButtonLabel">Artikel-Liste</span>
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Artikel</th>
                                    <th>Preis</th>
                                    <th width="120">Menge</th>
                                    <th>Gesamt</th>
                                    <th width="50"></th>
                                </tr>
                            </thead>
                            <tbody id="cartItems"></tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Zwischensumme:</strong></td>
                                    <td><strong id="subtotal">0,00 €</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="text-end">MwSt (19%):</td>
                                    <td id="vat">0,00 €</td>
                                    <td></td>
                                </tr>
                                <tr class="table-primary">
                                    <td colspan="3" class="text-end"><h4>Gesamt:</h4></td>
                                    <td><h4 id="total">0,00 €</h4></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zahlung und Aktionen (Button-ID für Kartenzahlung angepasst) -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="bi bi-person"></i> Kunde</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <div class="input-group">
                            <input type="text" class="form-control" id="customerSearch"
                                   placeholder="Kunde suchen oder Karte scannen..."
                                   autocomplete="off">
                            <button class="btn btn-outline-secondary" type="button" onclick="showCustomerList()">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <div id="customerSearchResults" class="list-group mt-1" style="display: none; max-height: 200px; overflow-y: auto;">
                            <!-- Suchergebnisse werden hier dynamisch eingefügt -->
                        </div>
                    </div>
                    <div class="alert alert-info mb-0 py-2" id="currentCustomer">
                        <i class="bi bi-person-badge"></i> <strong>Laufkunde</strong>
                        <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearCustomer()" style="display: none;" id="btnClearCustomer">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header"><h5><i class="bi bi-cash"></i> Zahlung</h5></div>
                <div class="card-body">
                    <div class="d-grid gap-2" id="payment-buttons">
                        {% for payment_method in zahlungsarten %}
                            <button class="btn btn-{{ 'success' if payment_method.id == 'BAR' else 'primary' }} btn-lg" 
                                    onclick="startPayment('{{ payment_method.id }}')"
                                    id="btn-payment-{{ payment_method.id }}">
                                <i class="bi {{ payment_method.icon }}"></i> {{ payment_method.name }}
                            </button>
                        {% endfor %}
                    </div>
                    <hr>
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning" onclick="parkSale()"><i class="bi bi-pause"></i> Verkauf parken</button>
                        <button class="btn btn-danger" onclick="cancelSale()"><i class="bi bi-x-circle"></i> Abbrechen</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Auftrags-Such-Modal -->
<div class="modal fade" id="orderSearchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-receipt"></i> Auftrags-Suche</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control form-control-lg" id="orderSearchInput"
                           placeholder="Auftragsnummer suchen..." autocomplete="off">
                </div>
                <div id="orderSearchResults" class="list-group" style="max-height: 400px; overflow-y: auto;">
                    <div class="list-group-item text-center text-muted">
                        Geben Sie eine Auftragsnummer ein...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bar-Zahlung Modal (unverändert) -->
<div class="modal fade" id="cashModal" tabindex="-1">
    {# ... Inhalt unverändert ... #}
</div>

<!-- NEU: SumUp "Warten" Modal -->
<div class="modal fade" id="sumupWaitingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Warte auf Kartenzahlung...</h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Bitte den Anweisungen auf dem SumUp-Terminal folgen.</p>
                <p><strong>Betrag: <span id="sumupAmount"></span></strong></p>
                <hr>
                <button class="btn btn-secondary" onclick="cancelSumUpPayment()">Zahlung am Terminal abbrechen</button>
            </div>
        </div>
    </div>
</div>

<!-- Artikel-Liste Modal (unverändert) -->
<div class="modal fade" id="articleListModal" tabindex="-1">
     {# ... Inhalt unverändert ... #}
</div>

<script>
// Globale Variablen
let cart = []; // Wird jetzt vom Backend über `get_warenkorb` befüllt
let articles = [];
let sumupWaitingModal = null;
let sumupCheckoutId = null;
let sumupPollingInterval = null;
let searchType = 'artikel'; // 'artikel' oder 'auftrag'
let searchTimeout = null;

// Initialisierung
document.addEventListener('DOMContentLoaded', function() {
    sumupWaitingModal = new bootstrap.Modal(document.getElementById('sumupWaitingModal'));

    // Lade initialen Warenkorb und aktualisiere die Anzeige
    fetchWarenkorb();

    // Enter-Suche
    document.getElementById('articleSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && this.value.trim() !== '') {
            performSearch(this.value.trim());
        }
    });

    // Live-Suche während Eingabe
    document.getElementById('articleSearch').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length >= 2) {
            searchTimeout = setTimeout(() => {
                showSearchResults(query);
            }, 300);
        } else {
            hideSearchResults();
        }
    });

    // Klick außerhalb schließt Suchergebnisse
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#articleSearch') && !e.target.closest('#searchResults')) {
            hideSearchResults();
        }
    });
});

// Suchtyp umschalten
function setSearchType(type) {
    searchType = type;
    document.getElementById('searchTypeLabel').textContent = type === 'artikel' ? 'Artikel' : 'Auftrag';
    document.getElementById('listButtonLabel').textContent = type === 'artikel' ? 'Artikel-Liste' : 'Auftrags-Liste';
    document.getElementById('articleSearch').placeholder =
        type === 'artikel' ? 'Artikelsuche (Name, Nr., Barcode)...' : 'Auftragssuche (Auftragsnummer)...';
    document.getElementById('articleSearch').focus();
    hideSearchResults();
}

// Zeigt Suchergebnisse an
function showSearchResults(query) {
    const url = searchType === 'artikel'
        ? `{{ url_for('kasse.artikel_suchen') }}?q=${encodeURIComponent(query)}`
        : `{{ url_for('kasse.auftraege_suchen') }}?q=${encodeURIComponent(query)}`;

    fetch(url)
    .then(res => res.json())
    .then(data => {
        const resultsDiv = document.getElementById('searchResults');
        resultsDiv.innerHTML = '';

        if (searchType === 'artikel' && data.success && data.artikel && data.artikel.length > 0) {
            data.artikel.forEach(artikel => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${artikel.name}</strong><br>
                            <small class="text-muted">Art.Nr.: ${artikel.article_number || '-'}</small>
                        </div>
                        <div class="text-end">
                            <strong>${artikel.preis.toFixed(2)} €</strong>
                        </div>
                    </div>
                `;
                item.onclick = (e) => {
                    e.preventDefault();
                    addArtikelToCart(artikel);
                    hideSearchResults();
                };
                resultsDiv.appendChild(item);
            });
            resultsDiv.style.display = 'block';
        } else if (searchType === 'auftrag' && data.success && data.auftraege && data.auftraege.length > 0) {
            data.auftraege.forEach(auftrag => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${auftrag.order_number}</strong><br>
                            <small class="text-muted">${auftrag.kunde} - ${auftrag.beschreibung}</small>
                        </div>
                        <div class="text-end">
                            <strong>${auftrag.preis.toFixed(2)} €</strong><br>
                            <span class="badge bg-info">${auftrag.status}</span>
                        </div>
                    </div>
                `;
                item.onclick = (e) => {
                    e.preventDefault();
                    addAuftragToCart(auftrag);
                    hideSearchResults();
                };
                resultsDiv.appendChild(item);
            });
            resultsDiv.style.display = 'block';
        } else {
            resultsDiv.innerHTML = '<div class="list-group-item">Keine Ergebnisse gefunden</div>';
            resultsDiv.style.display = 'block';
        }
    });
}

function hideSearchResults() {
    document.getElementById('searchResults').style.display = 'none';
}

// Führt Suche durch und fügt erstes Ergebnis hinzu (Enter)
function performSearch(query) {
    const url = searchType === 'artikel'
        ? `{{ url_for('kasse.artikel_suchen') }}?q=${encodeURIComponent(query)}`
        : `{{ url_for('kasse.auftraege_suchen') }}?q=${encodeURIComponent(query)}`;

    fetch(url)
    .then(res => res.json())
    .then(data => {
        if (searchType === 'artikel' && data.success && data.artikel && data.artikel.length > 0) {
            addArtikelToCart(data.artikel[0]);
            document.getElementById('articleSearch').value = '';
        } else if (searchType === 'auftrag' && data.success && data.auftraege && data.auftraege.length > 0) {
            addAuftragToCart(data.auftraege[0]);
            document.getElementById('articleSearch').value = '';
        } else {
            alert('Nichts gefunden.');
        }
        hideSearchResults();
    });
}

// Fügt Artikel zum Warenkorb hinzu
function addArtikelToCart(artikel) {
    const articleData = {
        artikel_id: artikel.id,
        name: artikel.name,
        preis: artikel.preis,
        menge: 1
    };
    updateWarenkorb("{{ url_for('kasse.warenkorb_hinzufuegen') }}", articleData);
}

// Fügt Auftrag zum Warenkorb hinzu
function addAuftragToCart(auftrag) {
    const auftragData = {
        artikel_id: null, // Kein Artikel, sondern Auftrag
        name: `Auftrag ${auftrag.order_number}${auftrag.beschreibung ? ' - ' + auftrag.beschreibung : ''}`,
        preis: auftrag.preis,
        menge: 1,
        auftrag_id: auftrag.id // Zusätzliche Info für Backend
    };
    updateWarenkorb("{{ url_for('kasse.warenkorb_hinzufuegen') }}", auftragData);
}

// --- NEUE, REFAKTORIERTE FUNKTIONEN ---

// Holt den Warenkorb vom Server
function fetchWarenkorb() {
    fetch("{{ url_for('kasse.warenkorb_hinzufuegen') }}", { // Dummy-Call um Summen zu bekommen
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
        if(data.warenkorb) {
            cart = data.warenkorb;
            updateCartDisplay(data.warenkorb, data.warenkorb_summen);
        }
    });
}

// Sucht einen Artikel und fügt ihn zum Warenkorb hinzu
function searchAndAddToCart(query) {
    fetch(`{{ url_for('kasse.artikel_suchen') }}?q=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
        if (data.success && data.artikel.length > 0) {
            // Nimm den ersten Treffer
            const article = data.artikel[0];
            const articleData = {
                artikel_id: article.id,
                name: article.name,
                preis: article.preis,
                menge: 1
            };
            // Sende an Server zum Hinzufügen
            updateWarenkorb("{{ url_for('kasse.warenkorb_hinzufuegen') }}", articleData);
        } else {
            alert('Artikel nicht gefunden.');
        }
    });
}

// Sendet Warenkorb-Änderungen an den Server
function updateWarenkorb(url, data) {
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(result => {
        if (result.success) {
            cart = result.warenkorb;
            updateCartDisplay(result.warenkorb, result.warenkorb_summen);
        } else {
            alert('Fehler: ' + result.error);
        }
    });
}

// Aktualisiert die Warenkorb-Anzeige im Frontend
function updateCartDisplay(warenkorb, summen) {
    const tbody = document.getElementById('cartItems');
    tbody.innerHTML = '';
    
    if (!warenkorb || warenkorb.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Warenkorb ist leer</td></tr>';
    } else {
        warenkorb.forEach(item => {
            tbody.innerHTML += `
                <tr>
                    <td><strong>${item.name}</strong></td>
                    <td>${formatCurrency(item.preis)}</td>
                    <td><input type="number" class="form-control form-control-sm" value="${item.menge}" min="1" onchange="updateQuantity('${item.warenkorb_id}', this.value)"></td>
                    <td>${formatCurrency(item.brutto_betrag)}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="removeFromCart('${item.warenkorb_id}')"><i class="bi bi-trash"></i></button></td>
                </tr>
            `;
        });
    }
    
    document.getElementById('subtotal').textContent = formatCurrency(summen.netto_gesamt);
    document.getElementById('vat').textContent = formatCurrency(summen.mwst_gesamt);
    document.getElementById('total').textContent = formatCurrency(summen.brutto_gesamt);
}

function updateQuantity(warenkorbId, menge) {
    updateWarenkorb("{{ url_for('kasse.warenkorb_aktualisieren') }}", { warenkorb_id: warenkorbId, menge: menge });
}

function removeFromCart(warenkorbId) {
    updateWarenkorb("{{ url_for('kasse.warenkorb_entfernen') }}", { warenkorb_id: warenkorbId });
}

// --- NEUE ZAHLUNGS-LOGIK ---

function startPayment(method) {
    if (cart.length === 0) {
        alert('Der Warenkorb ist leer!');
        return;
    }

    switch(method) {
        case 'BAR':
            // Barzahlung-Modal öffnen (Logik bleibt ähnlich)
            openCashModal();
            break;
        case 'SUMUP':
            startSumUpPayment();
            break;
        case 'RECHNUNG':
            // Auf Rechnung (Logik bleibt ähnlich)
            paymentInvoice();
            break;
    }
}

function openCashModal() {
    // Logik zum Öffnen und Befüllen des Bar-Modals
    // ...
}

function completeCashPayment() {
    // Schließt Bar-Verkauf ab
    const data = { zahlungsart: 'BAR', /* ... weitere Daten ... */ };
    fetch("{{ url_for('kasse.verkauf_abschliessen') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(handleSaleCompletion);
}

function startSumUpPayment() {
    document.getElementById('payment-buttons').querySelectorAll('button').forEach(b => b.disabled = true);

    fetch("{{ url_for('kasse.start_sumup_payment') }}", { method: 'POST' })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            sumupCheckoutId = data.checkout_id;
            document.getElementById('sumupAmount').textContent = formatCurrency(data.amount);
            sumupWaitingModal.show();
            
            // Starte Polling als Fallback zum Webhook
            startSumUpPolling(sumupCheckoutId);

            // HIER würde die Logik zur Aktivierung des Terminals via SumUp SDK/API kommen
            // z.B. sumup.pay(data.checkout_id);
            console.log("Starte SumUp-Zahlung mit Checkout-ID:", data.checkout_id);
            alert("Bitte Zahlung am SumUp Terminal durchführen. Dies ist eine Demo.");

        } else {
            alert('Fehler beim Starten der SumUp-Zahlung: ' + data.error);
            document.getElementById('payment-buttons').querySelectorAll('button').forEach(b => b.disabled = false);
        }
    });
}

function startSumUpPolling(checkoutId) {
    // Stoppe vorheriges Polling, falls vorhanden
    if (sumupPollingInterval) clearInterval(sumupPollingInterval);

    sumupPollingInterval = setInterval(() => {
        // Diese Route muss noch erstellt werden:
        fetch(`/kasse/zahlung/status/${checkoutId}`)
        .then(res => res.json())
        .then(data => {
            if (data.status === 'PAID') {
                console.log("Polling: Zahlung erfolgreich!");
                handleSaleCompletion({success: true, message: "Zahlung via SumUp erfolgreich."});
            }
        });
    }, 3000); // Alle 3 Sekunden prüfen
}

function cancelSumUpPayment() {
    // Stoppe das Polling
    if (sumupPollingInterval) clearInterval(sumupPollingInterval);
    sumupPollingInterval = null;
    
    sumupWaitingModal.hide();
    document.getElementById('payment-buttons').querySelectorAll('button').forEach(b => b.disabled = false);
    
    // Optional: Sende eine Storno-Anfrage an SumUp
    console.log("SumUp-Zahlung abgebrochen für Checkout-ID:", sumupCheckoutId);
}

function handleSaleCompletion(result) {
    // Stoppe jegliches Polling
    if (sumupPollingInterval) clearInterval(sumupPollingInterval);
    sumupPollingInterval = null;

    // Schließe alle Modals
    sumupWaitingModal.hide();
    // bootstrap.Modal.getInstance(document.getElementById('cashModal'))?.hide();

    if (result.success) {
        alert('Verkauf erfolgreich abgeschlossen! ' + (result.message || ''));
        
        // Warenkorb leeren und UI aktualisieren
        fetchWarenkorb(); 
        
        // Fokus zurück auf das Suchfeld
        document.getElementById('articleSearch').focus();
    } else {
        alert('Fehler beim Abschluss des Verkaufs: ' + (result.error || 'Unbekannter Fehler'));
    }
    
    // Buttons wieder aktivieren
    document.getElementById('payment-buttons').querySelectorAll('button').forEach(b => b.disabled = false);
}

// Hilfsfunktion
function formatCurrency(amount) {
    return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount);
}

function cancelSale() {
    if (confirm('Soll der Warenkorb wirklich geleert werden?')) {
        updateWarenkorb("{{ url_for('kasse.warenkorb_leeren') }}", {}); // Annahme: Route existiert
    }
}

// ==========================================
// KUNDENSUCHE UND -AUSWAHL
// ==========================================

let customerSearchTimeout = null;
let selectedCustomerId = null;

// Event-Listener für Kundensuche
document.getElementById('customerSearch').addEventListener('input', function(e) {
    const query = e.target.value.trim();

    // Debounce: Warte 300ms nach letzter Eingabe
    clearTimeout(customerSearchTimeout);

    if (query.length >= 2) {
        customerSearchTimeout = setTimeout(() => {
            searchCustomers(query);
        }, 300);
    } else if (query.length === 0) {
        // Bei leerem Suchfeld: Verstecke Suchergebnisse
        document.getElementById('customerSearchResults').style.display = 'none';
    }
});

// Kundensuche (auch für Barcode-Scanner)
function searchCustomers(query) {
    fetch(`{{ url_for('kasse.kunden_suchen') }}?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayCustomerResults(data.kunden);
            } else {
                console.error('Fehler bei Kundensuche:', data.error);
            }
        })
        .catch(error => {
            console.error('Fehler bei Kundensuche:', error);
        });
}

// Zeige Kunden-Suchergebnisse
function displayCustomerResults(kunden) {
    const resultsDiv = document.getElementById('customerSearchResults');

    if (kunden.length === 0) {
        resultsDiv.innerHTML = '<div class="list-group-item">Keine Kunden gefunden</div>';
        resultsDiv.style.display = 'block';
        return;
    }

    // Verwende data-Attribute statt inline onclick für Sicherheit
    resultsDiv.innerHTML = kunden.map(k => `
        <a href="#" class="list-group-item list-group-item-action customer-select-item"
           data-customer-id="${k.id}"
           data-customer-name="${k.name.replace(/"/g, '&quot;')}">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${k.name}</strong>
                    <br><small class="text-muted">${k.customer_number || ''} ${k.email || ''}</small>
                </div>
                <i class="bi bi-chevron-right"></i>
            </div>
        </a>
    `).join('');

    // Event-Listener für alle Kunden-Items
    resultsDiv.querySelectorAll('.customer-select-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const customerId = this.getAttribute('data-customer-id');
            const customerName = this.getAttribute('data-customer-name');
            selectCustomer(customerId, customerName);
        });
    });

    resultsDiv.style.display = 'block';
}

// Kunde auswählen
function selectCustomer(customerId, customerName) {
    fetch("{{ url_for('kasse.kunde_setzen') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({customer_id: customerId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            selectedCustomerId = customerId;

            // Aktualisiere Anzeige
            document.getElementById('currentCustomer').innerHTML = `
                <i class="bi bi-person-check-fill text-success"></i> <strong>${customerName}</strong>
                <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearCustomer()">
                    <i class="bi bi-x"></i>
                </button>
            `;
            document.getElementById('currentCustomer').className = 'alert alert-success mb-0 py-2';

            // Suchergebnisse ausblenden und Suchfeld leeren
            document.getElementById('customerSearchResults').style.display = 'none';
            document.getElementById('customerSearch').value = '';

            console.log('Kunde ausgewählt:', customerName);
        } else {
            alert('Fehler beim Setzen des Kunden: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Fehler beim Setzen des Kunden:', error);
        alert('Fehler beim Setzen des Kunden');
    });
}

// Kunde zurücksetzen (Laufkunde)
function clearCustomer() {
    fetch("{{ url_for('kasse.kunde_setzen') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({customer_id: null})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            selectedCustomerId = null;

            // Aktualisiere Anzeige
            document.getElementById('currentCustomer').innerHTML = `
                <i class="bi bi-person-badge"></i> <strong>Laufkunde</strong>
            `;
            document.getElementById('currentCustomer').className = 'alert alert-info mb-0 py-2';

            console.log('Kunde zurückgesetzt: Laufkunde');
        }
    })
    .catch(error => {
        console.error('Fehler beim Zurücksetzen des Kunden:', error);
    });
}

// Zeige komplette Kundenliste
function showCustomerList() {
    searchCustomers(''); // Leere Suche lädt die letzten 20 Kunden
    document.getElementById('customerSearch').focus();
}

// ==========================================
// ARTIKEL-SUCHE & AUFTRAGS-SUCHE MODALS
// ==========================================

// Generische Funktion zum Öffnen der Liste
function showList() {
    if (searchType === 'artikel') {
        showArticleList();
    } else {
        showOrderList();
    }
}

function showArticleList() {
    // Öffne das Artikel-Such-Modal
    const modal = new bootstrap.Modal(document.getElementById('articleSearchModal'));
    modal.show();

    // Fokus auf Suchfeld
    setTimeout(() => {
        document.getElementById('articleSearchInput').focus();
    }, 500);
}

function showOrderList() {
    // Öffne das Auftrags-Such-Modal
    const modal = new bootstrap.Modal(document.getElementById('orderSearchModal'));
    modal.show();

    // Lade alle Aufträge
    loadAllOrders();

    // Fokus auf Suchfeld
    setTimeout(() => {
        document.getElementById('orderSearchInput').focus();
    }, 500);
}

// Event-Listener für Auftrags-Suche im Modal
document.addEventListener('DOMContentLoaded', function() {
    const orderSearchInput = document.getElementById('orderSearchInput');
    if (orderSearchInput) {
        let orderSearchTimeout = null;

        orderSearchInput.addEventListener('input', function(e) {
            clearTimeout(orderSearchTimeout);
            const query = this.value.trim();

            if (query.length >= 1) {
                orderSearchTimeout = setTimeout(() => {
                    searchOrdersInModal(query);
                }, 300);
            } else {
                loadAllOrders();
            }
        });
    }
});

// Lade alle Aufträge (oder die letzten 50)
function loadAllOrders() {
    fetch(`{{ url_for('kasse.auftraege_suchen') }}?q=`)
    .then(res => res.json())
    .then(data => {
        displayOrderSearchResults(data);
    })
    .catch(error => {
        console.error('Fehler beim Laden der Aufträge:', error);
    });
}

// Suche Aufträge im Modal
function searchOrdersInModal(query) {
    fetch(`{{ url_for('kasse.auftraege_suchen') }}?q=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
        displayOrderSearchResults(data);
    })
    .catch(error => {
        console.error('Fehler bei der Auftragssuche:', error);
    });
}

// Zeige Auftrags-Suchergebnisse im Modal an
function displayOrderSearchResults(data) {
    const resultsDiv = document.getElementById('orderSearchResults');
    resultsDiv.innerHTML = '';

    if (data.success && data.auftraege && data.auftraege.length > 0) {
        data.auftraege.forEach(auftrag => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action';
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1"><strong>${auftrag.order_number}</strong></h6>
                        <p class="mb-1 text-muted">${auftrag.beschreibung}</p>
                        <small class="text-muted">
                            <i class="bi bi-person"></i> ${auftrag.kunde}
                            &nbsp;&nbsp;
                            <span class="badge bg-${getStatusBadgeClass(auftrag.status)}">${getStatusLabel(auftrag.status)}</span>
                        </small>
                    </div>
                    <div class="text-end">
                        <h5 class="mb-0">${auftrag.preis.toFixed(2)} €</h5>
                    </div>
                </div>
            `;
            item.onclick = (e) => {
                e.preventDefault();
                addAuftragToCart(auftrag);
                // Schließe Modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('orderSearchModal'));
                if (modal) modal.hide();
            };
            resultsDiv.appendChild(item);
        });
    } else {
        resultsDiv.innerHTML = '<div class="list-group-item text-center text-muted">Keine Aufträge gefunden</div>';
    }
}

// Hilfsfunktion für Status-Badge-Farbe
function getStatusBadgeClass(status) {
    const statusMap = {
        'accepted': 'primary',
        'in_progress': 'warning',
        'ready': 'success',
        'completed': 'secondary'
    };
    return statusMap[status] || 'secondary';
}

// Hilfsfunktion für Status-Label
function getStatusLabel(status) {
    const statusMap = {
        'accepted': 'Angenommen',
        'in_progress': 'In Bearbeitung',
        'ready': 'Fertig',
        'completed': 'Abgeschlossen'
    };
    return statusMap[status] || status;
}

// Override der selectArticle Funktion für die Kasse
// Diese Funktion wird vom Artikel-Modal aufgerufen
function selectArticle(articleId, articleName, articlePrice, articleColor, articleSize, articleMaterial, articleWeight) {
    // Füge Artikel direkt zum Warenkorb hinzu (nicht zu einem Select)
    fetch("{{ url_for('kasse.warenkorb_hinzufuegen') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            artikel_id: articleId,
            menge: 1
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Aktualisiere Warenkorb-Anzeige (richtige Funktionsname!)
            cart = data.warenkorb;
            updateCartDisplay(data.warenkorb, data.warenkorb_summen);

            // Schließe Modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('articleSearchModal'));
            if (modal) modal.hide();

            // Zeige Bestätigung
            showToast('Artikel hinzugefügt', `${articleName} wurde zum Warenkorb hinzugefügt`);

            // Fokus zurück auf Artikelsuche
            document.getElementById('articleSearch').focus();
        } else {
            alert('Fehler beim Hinzufügen: ' + (data.error || 'Unbekannter Fehler'));
        }
    })
    .catch(error => {
        console.error('Fehler beim Hinzufügen zum Warenkorb:', error);
        alert('Fehler beim Hinzufügen zum Warenkorb');
    });
}
</script>
{% endblock %}
