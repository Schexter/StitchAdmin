{% extends "base.html" %}

{% block title %}Qualitätskontrolle - {{ packing_list.packing_list_number }} - StitchAdmin{% endblock %}

{% block content %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="row">
    <div class="col-md-12">
        <h1>
            <i class="bi bi-clipboard-check"></i> Qualitätskontrolle
        </h1>
        <p class="lead">Packliste: {{ packing_list.packing_list_number }}</p>
        <div class="mt-3">
            <a href="{{ url_for('packing_lists.detail', id=packing_list.id) }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Zurück
            </a>
        </div>
    </div>
</div>

<form method="POST" class="mt-4">
    <div class="row">
        <div class="col-md-8">
            <!-- Artikel-Checkliste -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="bi bi-list-check"></i> Artikel prüfen</h5>
                </div>
                <div class="card-body">
                    <p>Bitte überprüfen Sie folgende Artikel:</p>
                    {% if items %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">
                                        <i class="bi bi-check-circle"></i>
                                    </th>
                                    <th>Artikel</th>
                                    <th>EAN</th>
                                    <th class="text-end">Soll-Menge</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input"
                                               id="item_{{ loop.index }}"
                                               style="width: 24px; height: 24px;">
                                    </td>
                                    <td>
                                        <label for="item_{{ loop.index }}" style="cursor: pointer;">
                                            {{ item.name }}
                                        </label>
                                    </td>
                                    <td>{{ item.ean or '-' }}</td>
                                    <td class="text-end">
                                        <strong>{{ item.quantity }}</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> Keine Artikel in dieser Packliste.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- QC-Checkliste -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="bi bi-check2-square"></i> Qualitäts-Checkliste</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="qc_complete">
                        <label class="form-check-label" for="qc_complete">
                            <strong>Alle Artikel vollständig</strong>
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="qc_quality">
                        <label class="form-check-label" for="qc_quality">
                            <strong>Qualität geprüft (keine Mängel)</strong>
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="qc_packaging">
                        <label class="form-check-label" for="qc_packaging">
                            <strong>Verpackungsmaterial bereit</strong>
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="qc_label">
                        <label class="form-check-label" for="qc_label">
                            <strong>Beschriftung/Etiketten korrekt</strong>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Notizen -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="bi bi-chat-left-text"></i> QC-Notizen</h5>
                </div>
                <div class="card-body">
                    <textarea class="form-control" id="qc_notes" name="qc_notes"
                              rows="4" placeholder="Optionale Notizen zur Qualitätskontrolle..."></textarea>
                    <small class="form-text text-muted">
                        Hier können Sie Besonderheiten, Abweichungen oder Anmerkungen notieren.
                    </small>
                </div>
            </div>

            <!-- Fotos hochladen (TODO: Implementierung in Tag 2) -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="bi bi-camera"></i> Fotos (optional)</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Foto-Upload wird in Tag 2 implementiert.
                    </div>
                    <!-- TODO: Foto-Upload Feld -->
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- QC-Ergebnis -->
            <div class="card mb-3">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="bi bi-clipboard-check"></i> QC-Ergebnis</h5>
                </div>
                <div class="card-body">
                    <p>Qualitätskontrolle durchgeführt von:</p>
                    <p><strong>{{ current_user.username }}</strong></p>
                    <p class="text-muted">
                        <i class="bi bi-clock"></i> {{ now().strftime('%d.%m.%Y %H:%M') }}
                    </p>
                    <hr>
                    <div class="d-grid gap-2">
                        <button type="submit" name="qc_result" value="passed"
                                class="btn btn-success btn-lg"
                                id="btn-passed" disabled>
                            <i class="bi bi-check-circle-fill"></i> QC Bestanden
                        </button>
                        <button type="submit" name="qc_result" value="failed"
                                class="btn btn-danger btn-lg">
                            <i class="bi bi-x-circle-fill"></i> QC Nicht Bestanden
                        </button>
                    </div>
                    <small class="form-text text-muted mt-2 d-block">
                        Bei "Nicht Bestanden" wird die Packliste auf Status "Bereit zur Verpackung" zurückgesetzt.
                    </small>
                </div>
            </div>

            <!-- Kundenvorgaben -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="bi bi-info-circle"></i> Kundenvorgaben</h5>
                </div>
                <div class="card-body">
                    {% if packing_list.customer_notes %}
                    <p>{{ packing_list.customer_notes }}</p>
                    {% else %}
                    <p class="text-muted">Keine Kundenvorgaben</p>
                    {% endif %}
                </div>
            </div>

            <!-- Interne Notizen -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="bi bi-sticky"></i> Interne Notizen</h5>
                </div>
                <div class="card-body">
                    {% if packing_list.packing_notes %}
                    <p>{{ packing_list.packing_notes }}</p>
                    {% else %}
                    <p class="text-muted">Keine internen Notizen</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</form>

<script>
// Aktiviere "QC Bestanden" Button nur wenn alle Checkboxen aktiviert sind
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    const btnPassed = document.getElementById('btn-passed');

    function updateButtonState() {
        let allChecked = true;
        checkboxes.forEach(checkbox => {
            if (!checkbox.checked) {
                allChecked = false;
            }
        });
        btnPassed.disabled = !allChecked;
    }

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateButtonState);
    });

    updateButtonState();
});
</script>

{% endblock %}
