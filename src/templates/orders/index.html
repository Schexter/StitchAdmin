{% extends "base.html" %}

{% block title %}Aufträge - StitchAdmin{% endblock %}

{% block content %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<div class="row">
    <div class="col-md-12">
        <h1><i class="bi bi-clipboard-check"></i> Aufträge</h1>
        <div class="mt-3">
            <a href="{{ url_for('orders.new') }}" class="btn btn-success btn-lg">
                <i class="bi bi-plus-lg"></i> Neuer Auftrag
            </a>
        </div>
    </div>
</div>

<!-- Filter -->
<div class="card mb-3">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Status</label>
                <select class="form-control" name="status">
                    <option value="">Alle Aufträge</option>
                    <option value="accepted" {% if status_filter == 'accepted' %}selected{% endif %}>Angenommen</option>
                    <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Arbeit</option>
                    <option value="ready" {% if status_filter == 'ready' %}selected{% endif %}>Abholbereit</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Abgeholt</option>
                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Storniert</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-funnel"></i> Filtern
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Aufträge-Tabelle -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Auftrags-Nr.</th>
                        <th>Datum</th>
                        <th>Kunde</th>
                        <th>Design/Artikel</th>
                        <th>Typ</th>
                        <th>Anzahl</th>
                        <th>Preis</th>
                        <th>Status</th>
                        <th>Material</th>
                        <th>Abholdatum</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td>
                            <a href="{{ url_for('orders.show', order_id=order.id) }}">
                                {{ order.order_number or order.id }}
                            </a>
                        </td>
                        <td><small>{{ order.created_at|format_date or '-' }}</small></td>
                        <td>
                            {% if order.customer %}
                            <a href="{{ url_for('customers.show', customer_id=order.customer_id) }}">
                                {{ order.customer.first_name }} {{ order.customer.last_name }}
                            </a>
                            {% else %}
                                <span class="text-muted">Kunde gelöscht</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 200px;" title="{{ order.description or '' }}">
                                {{ (order.description or 'Keine Beschreibung')[:50] }}{% if order.description and order.description|length > 50 %}...{% endif %}
                            </div>
                            
                            <!-- Design-Status-Badges (NEU) -->
                            {% if order.design_status %}
                                {% if order.design_status == 'none' %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-exclamation-triangle"></i> Design fehlt
                                    </span>
                                {% elif order.design_status == 'needs_order' %}
                                    <span class="badge bg-warning">
                                        <i class="bi bi-cart-plus"></i> Design bestellen
                                    </span>
                                {% elif order.design_status == 'ordered' %}
                                    <span class="badge bg-info">
                                        <i class="bi bi-hourglass-split"></i> Design im Zulauf
                                    </span>
                                {% elif order.design_status == 'received' %}
                                    <span class="badge bg-primary">
                                        <i class="bi bi-download"></i> Design erhalten
                                    </span>
                                {% elif order.design_status == 'ready' %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> Design bereit
                                    </span>
                                {% elif order.design_status == 'customer_provided' %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> Kunde bereitgestellt
                                    </span>
                                {% endif %}
                            {% else %}
                                <!-- Fallback für bestehende Aufträge -->
                                {% if not order.design_file and not order.design_file_path %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-exclamation-triangle"></i> Logo fehlt
                                    </span>
                                {% endif %}
                            {% endif %}
                            
                            <!-- Legacy-Code für bestehende Aufträge -->
                            {% if order.special_instructions and 'LOGO-BESTELLUNG ERFORDERLICH' in order.special_instructions %}
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-cart"></i> Logo bestellen
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.order_type == 'embroidery' %}
                                <span class="badge bg-primary">Bestickung</span>
                            {% elif order.order_type == 'printing' %}
                                <span class="badge bg-success">Textildruck</span>
                            {% elif order.order_type == 'combined' %}
                                <span class="badge bg-info">Bestickung + Druck</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ order.order_type or 'Unbekannt' }}</span>
                            {% endif %}
                            {% if order.rush_order %}
                                <br><span class="badge bg-danger">EXPRESS</span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>1</strong>
                        </td>
                        <td>
                            {{ "%.2f"|format(order.total_price or 0) }} €
                            {% if order.stitch_count %}
                                <br><small class="text-muted">{{ order.stitch_count }} Stiche</small>
                            {% endif %}
                            {% if order.print_width_cm and order.print_height_cm %}
                                <br><small class="text-muted">{{ order.print_width_cm }}x{{ order.print_height_cm }}cm</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.status == 'pending' %}
                                <span class="badge bg-secondary">Ausstehend</span>
                            {% elif order.status == 'accepted' %}
                                <span class="badge bg-primary">Angenommen</span>
                            {% elif order.status == 'in_progress' %}
                                <span class="badge bg-warning">In Arbeit</span>
                            {% elif order.status == 'ready' %}
                                <span class="badge bg-success">Abholbereit</span>
                            {% elif order.status == 'completed' %}
                                <span class="badge bg-secondary">Abgeholt</span>
                            {% elif order.status == 'cancelled' %}
                                <span class="badge bg-danger">Storniert</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ order.status or 'Unbekannt' }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set items_to_order = order.items.filter_by(supplier_order_status='none').count() %}
                            {% set items_ordered = order.items.filter_by(supplier_order_status='ordered').count() %}
                            {% if items_to_order > 0 %}
                                <span class="badge bg-warning" title="{{ items_to_order }} Position(en) zu bestellen">
                                    <i class="bi bi-exclamation-circle"></i> {{ items_to_order }}
                                </span>
                            {% endif %}
                            {% if items_ordered > 0 %}
                                <span class="badge bg-info" title="{{ items_ordered }} Position(en) bestellt">
                                    <i class="bi bi-clock"></i> {{ items_ordered }}
                                </span>
                            {% endif %}
                            {% if items_to_order == 0 and items_ordered == 0 %}
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle"></i> OK
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.due_date %}
                                <small>{{ order.due_date|format_date }}</small>
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" 
                                        data-bs-toggle="dropdown">
                                    Status ändern
                                </button>
                                <ul class="dropdown-menu">
                                    {% if order.status != 'in_progress' and order.status not in ['completed', 'cancelled'] %}
                                    <li>
                                        <form method="POST" action="{{ url_for('orders.update_status', order_id=order.id) }}" 
                                              style="display: inline;">
                                            <input type="hidden" name="status" value="in_progress">
                                            <button type="submit" class="dropdown-item">
                                                <i class="bi bi-gear text-warning"></i> In Arbeit
                                            </button>
                                        </form>
                                    </li>
                                    {% endif %}
                                    {% if order.status == 'in_progress' %}
                                    <li>
                                        <form method="POST" action="{{ url_for('orders.update_status', order_id=order.id) }}" 
                                              style="display: inline;">
                                            <input type="hidden" name="status" value="ready">
                                            <button type="submit" class="dropdown-item">
                                                <i class="bi bi-check-circle text-success"></i> Abholbereit
                                            </button>
                                        </form>
                                    </li>
                                    {% endif %}
                                    {% if order.status == 'ready' %}
                                    <li>
                                        <form method="POST" action="{{ url_for('orders.update_status', order_id=order.id) }}" 
                                              style="display: inline;">
                                            <input type="hidden" name="status" value="completed">
                                            <button type="submit" class="dropdown-item">
                                                <i class="bi bi-check-circle-fill text-secondary"></i> Abgeholt
                                            </button>
                                        </form>
                                    </li>
                                    {% endif %}
                                    {% if order.status not in ['completed', 'cancelled'] %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form method="POST" action="{{ url_for('orders.update_status', order_id=order.id) }}" 
                                              style="display: inline;"
                                              onsubmit="return confirm('Auftrag wirklich stornieren?');">
                                            <input type="hidden" name="status" value="cancelled">
                                            <button type="submit" class="dropdown-item text-danger">
                                                <i class="bi bi-x-circle"></i> Stornieren
                                            </button>
                                        </form>
                                    </li>
                                    {% endif %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a href="{{ url_for('orders.edit', order_id=order.id) }}" class="dropdown-item">
                                            <i class="bi bi-pencil"></i> Bearbeiten
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center text-muted">
                            Keine Aufträge gefunden
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="mt-3">
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Zurück zum Dashboard
    </a>
</div>
{% endblock %}